<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DungeonMind v17.7 | DeepSeek V3 (0324)</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, updateDoc, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyCSwJqc4aLCUG_HSEhw4KoA056Qd2y1CB4", authDomain: "dungeonmind-aa529.firebaseapp.com", projectId: "dungeonmind-aa529", storageBucket: "dungeonmind-aa529.firebasestorage.app", messagingSenderId: "839802457564", appId: "1:839802457564:web:97aa6ea99190aa59acd319", measurementId: "G-Z0TEJSQ0WF" };
        try {
            const app = initializeApp(firebaseConfig);
            window.fbModules = { app, auth: getAuth(app), db: getFirestore(app), GoogleAuthProvider, signInWithPopup, signOut, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, onAuthStateChanged, arrayUnion, arrayRemove };
        } catch(e) { console.error("Firebase Init Failed", e); window.firebaseError = e.message; }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&family=Fira+Code:wght@400&display=swap" rel="stylesheet">
    <style>
        :root { --bg-dark: #0f172a; --bg-panel: #1e293b; --accent: #d97706; }
        body { font-family: 'Lato', sans-serif; background-color: var(--bg-dark); color: #e2e8f0; overflow: hidden; touch-action: manipulation; }
        h1, h2, h3, .fantasy-font { font-family: 'Cinzel', serif; }
        .mono-font { font-family: 'Fira Code', monospace; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .glass-panel { background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255, 255, 255, 0.05); }
        input, textarea, select { font-size: 16px !important; }
        #app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: opacity 0.5s; }
        .loader-spinner { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #d97706; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #force-offline-btn { display: none; margin-top: 20px; padding: 10px 20px; background: #334155; color: white; border: 1px solid #475569; border-radius: 8px; cursor: pointer; }
        /* NUCLEAR STRIKETHROUGH REMOVAL */
        s, strike, del { text-decoration: none !important; color: inherit; }
        * { text-decoration-line: none !important; }
    </style>
</head>
<body>
    <div id="app-loader"><div class="loader-spinner"></div><h2 style="margin-top:20px;font-family:serif;">Summoning DungeonMind...</h2><button id="force-offline-btn" onclick="window.forceOffline()">Force Offline</button></div>
    <div id="root"></div>
    <script>setTimeout(()=>{const b=document.getElementById('force-offline-btn');if(b)b.style.display='block';},4000);window.forceOffline=function(){window.forcedOfflineMode=true;};</script>
    <script type="text/babel">
        const hideLoader = () => { const l = document.getElementById('app-loader'); if(l) { l.style.opacity=0; setTimeout(()=>l.style.display='none',500); } };
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const { useState, useEffect, useRef, Component } = React;

        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) return <div className="h-screen flex flex-col items-center justify-center bg-red-950 text-white p-8"><h1 className="text-2xl font-bold">Critical Failure</h1><p className="bg-black/30 p-4 rounded font-mono text-xs mt-4">{this.state.error?.toString()}</p><button onClick={()=>window.location.reload()} className="mt-4 bg-white text-red-900 px-4 py-2 rounded font-bold">Reload</button></div>;
                return this.props.children;
            }
        }

        const useFirebase = () => {
            const [fb, setFb] = useState(null);
            const [user, setUser] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            useEffect(() => {
                const init = async () => {
                    while (!window.fbModules) { await new Promise(r => setTimeout(r, 100)); if(window.forcedOfflineMode) { setIsAuthReady(true); return; } }
                    const { auth, onAuthStateChanged } = window.fbModules;
                    onAuthStateChanged(auth, u => { setUser(u); setIsAuthReady(true); });
                    setFb({ ...window.fbModules, appId: 'dungeonmind' });
                };
                init();
            }, []);
            return { fb, user, isAuthReady, isOffline: !fb && window.forcedOfflineMode };
        };

        const Icon = ({ name, size = 20 }) => {
            const r = useRef(null);
            useEffect(() => { if (window.lucide && r.current) window.lucide.createIcons({ root: r.current, nameAttr: 'data-lucide', attrs: { class: `w-${size/4} h-${size/4}`, width: size, height: size } }); }, [name, size]);
            return <span ref={r} className="inline-flex"><i data-lucide={name}></i></span>;
        };

        const JournalBox = ({ title, value, onChange, colorClass, type, placeholder, maximized, setMaximized }) => {
            const isMax = maximized === type;
            if (maximized && !isMax) return null;
            const downloadTxt = () => { const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([value],{type:"text/plain"})); a.download=`${title}.txt`; a.click(); };
            return (
                <div className={`flex flex-col glass-panel rounded-xl overflow-hidden journal-expand ${isMax ? 'fixed inset-4 z-50' : 'flex-1 min-h-[300px]'} ${colorClass}`}>
                    <div className={`p-2 text-center text-xs uppercase font-bold border-b flex justify-between items-center ${type==='dm'?'bg-red-900/20 text-red-400':type==='personal'?'bg-indigo-900/20 text-indigo-300':'bg-slate-800/50 text-green-400'}`}>
                        <span>{title}</span>
                        <div className="flex gap-2"><button onClick={downloadTxt}><Icon name="download" size={14}/></button><button onClick={()=>setMaximized(isMax?null:type)}><Icon name={isMax?"minimize-2":"maximize-2"} size={14}/></button></div>
                    </div>
                    <textarea value={value||""} onChange={e=>onChange(e.target.value)} className={`w-full h-full bg-transparent p-4 resize-none focus:outline-none custom-scroll ${type==='dm'?'text-red-100':'text-slate-200'}`} placeholder={placeholder}/>
                </div>
            );
        };

        const SettingsView = ({ data, setData, apiKey, setApiKey, role, updateCloud, code, user, fb, workerUrl, setWorkerUrl, handlePdfUpload, clearPdf, pdfProcessing }) => {
            const copyCode = () => { navigator.clipboard.writeText(code); alert("Copied"); };
            return (
                <div className="max-w-3xl mx-auto p-8 overflow-y-auto h-full custom-scroll">
                    <h2 className="text-3xl fantasy-font text-amber-500 mb-6 border-b border-slate-800 pb-2">Settings</h2>
                    <div className="glass-panel p-8 rounded-xl mb-8 flex flex-col items-center text-center border-2 border-indigo-500/30 bg-indigo-900/10">
                        <h3 className="text-xs font-bold text-indigo-300 uppercase tracking-widest mb-2">Invite Code</h3>
                        <div className="text-5xl font-mono font-bold text-white tracking-widest mb-4">{code}</div>
                        <div className="flex gap-2"><button onClick={copyCode} className="bg-indigo-600 px-4 py-1 rounded text-sm flex items-center gap-2"><Icon name="copy" size={16}/> Copy</button>{fb && user && <button onClick={()=>fb.signOut(fb.auth)} className="bg-slate-700 px-4 py-1 rounded text-sm">Sign Out</button>}</div>
                    </div>
                    <div className="glass-panel p-6 rounded-xl mb-6 border-l-4 border-amber-500">
                        <h3 className="text-lg font-bold mb-2 text-slate-200">AI Connection (DeepSeek)</h3>
                        <div className="mb-3 space-y-3">
                            <div>
                                <label className="block text-xs text-slate-400 mb-1">Provider Model</label>
                                <div className="w-full bg-slate-900 border border-slate-700 p-2 rounded text-slate-200 text-sm font-mono flex justify-between items-center">
                                    <span>deepseek/deepseek-chat-v3-0324:free</span>
                                    <span className="text-green-500 text-[10px] uppercase border border-green-500 px-1 rounded">Active</span>
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs text-slate-400 mb-1">OpenRouter API Key (Required)</label>
                                <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} className="w-full bg-slate-900 border border-slate-700 p-3 rounded text-slate-200 outline-none font-mono" placeholder="sk-or-v1-..." />
                            </div>
                            <div>
                                <label className="block text-xs text-slate-400 mb-1">Proxy Worker URL</label>
                                <input value={workerUrl} onChange={e => setWorkerUrl(e.target.value)} className="w-full bg-slate-900 border border-slate-700 p-3 rounded text-slate-200 outline-none font-mono text-xs" />
                            </div>
                        </div>
                    </div>
                    {role === 'dm' && (
                        <div className="glass-panel p-6 rounded-xl border-l-4 border-blue-500">
                            <h3 className="text-lg font-bold mb-4 text-slate-200">DM Tools</h3>
                            <div className="grid md:grid-cols-2 gap-6 mb-4">
                                <div><label className="block text-xs font-bold text-slate-400 uppercase mb-2">Edition</label><select value={data.config?.edition||'2014'} onChange={e=>setData({...data, config:{...data.config, edition:e.target.value}})} className="w-full bg-slate-900 border border-slate-700 p-2 rounded text-slate-200"><option value="2014">5e (2014)</option><option value="2024">5e (2024)</option></select></div>
                                <div><label className="block text-xs font-bold text-slate-400 uppercase mb-2">Strict Mode</label><button onClick={()=>setData({...data, config:{...data.config, strictMode:!data.config?.strictMode}})} className={`w-full p-2 rounded text-sm border ${data.config?.strictMode?'bg-green-900/50 border-green-600 text-green-400':'bg-slate-900 border-slate-700 text-slate-400'}`}>{data.config?.strictMode?"Strict":"General"}</button></div>
                            </div>
                             <div className="border-2 border-dashed border-slate-700 rounded p-4 text-center mt-4">
                                {pdfProcessing ? <div className="text-amber-500 animate-pulse">Processing...</div> : !data.campaign?.pdfName ? (
                                    <label className="cursor-pointer block w-full"><span className="text-slate-300 font-bold">Upload PDF</span><input type="file" className="hidden" accept=".pdf" onChange={handlePdfUpload}/></label>
                                ) : (
                                    <div className="flex justify-between"><span className="text-green-400">{data.campaign.pdfName}</span><button onClick={clearPdf}><Icon name="trash-2" size={16}/></button></div>
                                )}
                            </div>
                            <button onClick={()=>setData({...data, campaign:{...data.campaign, location: prompt("New Location:", data.campaign.location)}})} className="w-full bg-slate-800 p-2 mt-4 rounded text-sm">Set Location</button>
                        </div>
                    )}
                </div>
            );
        };

        const GameSession = ({ fb, code, role: initRole, userId, user, isOffline, onExit }) => {
            const DEFAULT = { hostId: userId, campaign:{ name:"New", location:"Start", tone:"Heroic", pdfName:null, pdfText:null}, config:{edition:'2014', strictMode:false}, players:[], journal_public:"", journal_dm:"", player_journals:{}, activeUsers:{}, bannedUsers:[], assignments:{} };
            const [data, setData] = useState(null);
            const [view, setView] = useState('session');
            const [role, setRole] = useState(initRole);
            const [chatHistory, setChatHistory] = useState([{role:'system', content:`Connected ${code}`}]);
            const [inputText, setInputText] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('dm_key_openrouter') || '');
            const [workerUrl, setWorkerUrl] = useState(() => localStorage.getItem('dm_worker_url') || 'https://dungeonmind-proxy.heangeloff03.workers.dev');
            const [pdfProcessing, setPdfProcessing] = useState(false);
            const saveTimer = useRef(null);
            
            // Hardcoded Specific Model
            const MODEL_ID = "deepseek/deepseek-chat-v3-0324:free";

            useEffect(() => { localStorage.setItem('dm_key_openrouter', apiKey); }, [apiKey]);
            useEffect(() => { localStorage.setItem('dm_worker_url', workerUrl); }, [workerUrl]);

            useEffect(() => {
                if(isOffline) { const l=localStorage.getItem('dm_loc'); setData(l?JSON.parse(l):DEFAULT); hideLoader(); return; }
                const unsub = fb.onSnapshot(fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'campaigns', code), snap => {
                    if(snap.exists()) { setData(snap.data()); setRole(snap.data().hostId === userId ? 'dm' : 'player'); hideLoader(); }
                    else if (initRole === 'dm') fb.setDoc(fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'campaigns', code), DEFAULT);
                    else { alert("Campaign not found"); onExit(); }
                });
                return () => unsub();
            }, [code]);

            const updateCloud = (nd) => {
                setData(nd);
                if(isOffline) { localStorage.setItem('dm_loc', JSON.stringify(nd)); return; }
                if(saveTimer.current) clearTimeout(saveTimer.current);
                saveTimer.current = setTimeout(() => {
                     const ref = fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'campaigns', code);
                     if(role === 'player') fb.updateDoc(ref, { players: nd.players, journal_public: nd.journal_public, [`player_journals.${userId}`]: nd.player_journals[userId] || "" });
                     else fb.setDoc(ref, nd, { merge: true });
                }, 1000);
            };

            const cleanText = (t) => t.replace(/~/g, "").replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br/>');

            const genResponse = async () => {
                if(!inputText.trim()) return;
                setChatHistory(p=>[...p, {role:'user', content:inputText}]);
                const q = inputText; setInputText(''); setIsLoading(true);

                try {
                    if(!apiKey) throw new Error("Missing OpenRouter Key in Settings");
                    const char = data.players.find(p=>p.id==data.assignments?.[userId]);
                    const prompt = `Role: DM AI. User: ${role==='dm'?'DM':(char?char.name:'Player')}. Rules: 5e. Ctx: ${data.campaign.location}. Log: ${data.journal_public}. ${role==='dm'?`SECRETS:${data.journal_dm} PDF:${data.campaign.pdfText?.slice(0,20000)}`:""} Q: ${q}`;

                    const res = await fetch(workerUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                        body: JSON.stringify({ model: MODEL_ID, messages: [{ role: "user", content: prompt }] })
                    });
                    
                    if(!res.ok) { const txt = await res.text(); throw new Error(txt); }
                    const json = await res.json();
                    if(json.error) throw new Error(json.error.message || JSON.stringify(json.error));
                    setChatHistory(p=>[...p, {role:'ai', content:json.choices?.[0]?.message?.content || "No response"}]);

                } catch(e) {
                    setChatHistory(p=>[...p, {role:'system', content:`Error: ${e.message}`}]);
                } finally { setIsLoading(false); }
            };

            const handlePdf = async (e) => {
                const f = e.target.files[0]; if(!f) return; setPdfProcessing(true);
                try {
                    const ab = await f.arrayBuffer(); const pdf = await pdfjsLib.getDocument({data:ab}).promise;
                    let t = ""; for(let i=1;i<=Math.min(pdf.numPages,50);i++) t+=(await (await pdf.getPage(i)).getTextContent()).items.map(s=>s.str).join(' ');
                    updateCloud({...data, campaign:{...data.campaign, pdfName:f.name, pdfText:t}});
                } catch(e){alert("PDF Error");} finally { setPdfProcessing(false); }
            };

            if(!data) return <div className="h-screen flex items-center justify-center text-white">Syncing...</div>;

            return (
                <div className="flex h-screen w-full bg-slate-900 text-slate-200">
                    <aside className="w-16 bg-slate-900 border-r border-slate-800 flex flex-col items-center py-4 gap-4">
                        <div className="text-amber-500 mb-2"><Icon name="dungeon" size={32}/></div>
                        {['session', 'journal', 'settings'].map(v => <button key={v} onClick={()=>setView(v)} className={`p-2 ${view===v?'text-amber-400':'text-slate-500'}`}><Icon name={v==='session'?'scroll-text':v==='journal'?'book-open-text':'settings-2'} size={24}/></button>)}
                        <button onClick={onExit} className="mt-auto text-red-500"><Icon name="log-out" size={24}/></button>
                    </aside>
                    <main className="flex-1 overflow-hidden relative">
                        {view === 'session' && (
                            <div className="flex flex-col h-full">
                                <div className="h-12 border-b border-slate-800 flex items-center justify-between px-4 bg-slate-900/90">
                                    <span className="font-bold text-amber-500">{data.campaign.location}</span>
                                    <span className="text-xs text-slate-500">DeepSeek V3 (0324)</span>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scroll pb-20">
                                    {chatHistory.map((m,i) => <div key={i} className={`p-3 rounded max-w-[85%] ${m.role==='user'?'bg-slate-800 ml-auto':m.role==='system'?'mx-auto text-center text-xs text-slate-500':'bg-indigo-900/20 mr-auto'}`} dangerouslySetInnerHTML={{__html:cleanText(m.content)}}/>)}
                                    {isLoading && <div className="text-xs text-center text-slate-500 animate-pulse">DeepSeek is thinking...</div>}
                                </div>
                                <div className="p-4 bg-slate-900 border-t border-slate-800 flex gap-2">
                                    <input value={inputText} onChange={e=>setInputText(e.target.value)} onKeyDown={e=>{if(e.key==='Enter')genResponse()}} className="flex-1 bg-slate-800 rounded p-3 text-white outline-none" placeholder="What happens next?"/>
                                    <button onClick={genResponse} className="bg-amber-600 px-4 rounded text-white"><Icon name="send" size={20}/></button>
                                </div>
                            </div>
                        )}
                        {view === 'journal' && <JournalView data={data} setData={setData} role={role} updateCloud={updateCloud} userId={userId}/>}
                        {view === 'settings' && <SettingsView data={data} setData={setData} apiKey={apiKey} setApiKey={setApiKey} role={role} updateCloud={updateCloud} code={code} user={user} fb={fb} workerUrl={workerUrl} setWorkerUrl={setWorkerUrl} handlePdfUpload={handlePdf} clearPdf={()=>{updateCloud({...data, campaign:{...data.campaign, pdfName:null, pdfText:null}})}} pdfProcessing={pdfProcessing}/>}
                    </main>
                </div>
            );
        };

        const Lobby = ({ fb, user, onJoin, onOffline }) => {
            const [code, setCode] = useState("");
            return (
                <div className="h-screen flex flex-col items-center justify-center bg-slate-900 text-white p-4">
                     <h1 className="text-5xl fantasy-font text-amber-500 mb-2">DungeonMind</h1>
                     <p className="mb-8 text-slate-400">DeepSeek Edition</p>
                     {!user && !fb ? <button onClick={onOffline} className="text-slate-500">Offline Mode</button> :
                     user ? <div className="w-full max-w-sm space-y-4">
                        <div className="text-center text-green-400">Logged in as {user.email}</div>
                        <button onClick={()=>{const c=Math.random().toString(36).substring(2,8).toUpperCase(); onJoin(c,'dm',user.uid)}} className="w-full bg-amber-700 py-3 rounded font-bold">New Campaign (DM)</button>
                        <div className="flex gap-2"><input value={code} onChange={e=>setCode(e.target.value.toUpperCase())} placeholder="CODE" className="flex-1 bg-slate-800 text-center rounded p-2 outline-none"/><button onClick={()=>code && onJoin(code,'player',user.uid)} className="bg-slate-700 px-4 rounded">Join</button></div>
                     </div> :
                     <button onClick={()=>fb.signInWithPopup(fb.auth, new fb.GoogleAuthProvider())} className="bg-indigo-600 px-6 py-3 rounded font-bold">Login with Google</button>}
                </div>
            );
        };

        function App() {
            const { fb, user, isAuthReady, isOffline } = useFirebase();
            const [view, setView] = useState('lobby');
            const [params, setParams] = useState(null);
            if(!isAuthReady) return null; setTimeout(hideLoader, 100);
            return view==='lobby' ? <Lobby fb={fb} user={user} onJoin={(c,r,u)=>{setParams({fb,code:c,role:r,userId:u,user}); setView('game');}} onOffline={()=>{setParams({fb:null,code:'LOCAL',role:'dm',userId:'loc',isOffline:true}); setView('game');}}/> : <ErrorBoundary><GameSession {...params} onExit={()=>{setView('lobby');setParams(null);}}/></ErrorBoundary>;
        }
        const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
    </script>
</body>
</html>
