<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DungeonMind v26 | Mobile Enhanced</title>
    
    <!-- GLOBAL ERROR HANDLER -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const loaderText = document.getElementById('loader-text');
            const loaderSub = document.getElementById('loader-sub');
            if (loaderText) {
                loaderText.innerText = "Startup Error";
                loaderText.style.color = "#ef4444";
                if(loaderSub) loaderSub.innerText = msg;
            }
            return false;
        };
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- Puter.js -->
    <script src="https://js.puter.com/v2/"></script>

    <!-- Firebase Modular SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, updateDoc, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCSwJqc4aLCUG_HSEhw4KoA056Qd2y1CB4",
            authDomain: "dungeonmind-aa529.firebaseapp.com",
            projectId: "dungeonmind-aa529",
            storageBucket: "dungeonmind-aa529.firebasestorage.app",
            messagingSenderId: "839802457564",
            appId: "1:839802457564:web:97aa6ea99190aa59acd319",
            measurementId: "G-Z0TEJSQ0WF"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            window.fbModules = { 
                app, auth, db, 
                GoogleAuthProvider, signInWithPopup, signOut, 
                doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, onAuthStateChanged, arrayUnion, arrayRemove
            };
            console.log("Firebase initialized");
            window.dispatchEvent(new Event('firebase-ready'));
        } catch(e) {
            console.error("Firebase Failed", e);
            window.dispatchEvent(new Event('firebase-failed'));
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&family=Fira+Code:wght@400&display=swap" rel="stylesheet">

    <style>
        :root { --bg-dark: #0f172a; --bg-panel: #1e293b; --accent: #d97706; }
        body { font-family: 'Lato', sans-serif; background-color: var(--bg-dark); color: #e2e8f0; overflow: hidden; touch-action: manipulation; }
        h1, h2, h3, .fantasy-font { font-family: 'Cinzel', serif; }
        .mono-font { font-family: 'Fira Code', monospace; }
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .glass-panel { background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255, 255, 255, 0.05); }
        /* Fix text size on mobile to prevent zoom */
        input, textarea, select { font-size: 16px !important; }
        
        /* Mobile height fix */
        .h-dvh { height: 100vh; height: 100dvh; }
        
        #app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: opacity 0.5s; }
        .loader-spinner { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #d97706; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #force-offline-btn { display: none; margin-top: 20px; padding: 10px 20px; background: #334155; color: white; border: 1px solid #475569; border-radius: 8px; cursor: pointer; font-family: sans-serif; }
        #force-offline-btn:hover { background: #475569; }
        .journal-expand { transition: all 0.3s ease-in-out; }
        .chat-content s, .chat-content strike, .chat-content del { text-decoration: none !important; }
        .npc-card:hover { transform: translateY(-2px); border-color: #d97706; }
        .chat-image { max-width: 100%; border-radius: 8px; margin-top: 8px; border: 2px solid #d97706; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .onboarding-step { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .collab-status { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; transition: all 0.3s; }
        .status-saved { color: #4ade80; background: rgba(74, 222, 128, 0.1); }
        .status-saving { color: #facc15; background: rgba(250, 204, 21, 0.1); }
        .status-error { color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        
        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            .mobile-full-height { height: calc(100dvh - 60px); } /* Account for bottom nav */
            .glass-panel { border: none; }
        }
    </style>
</head>
<body>
    <div id="app-loader">
        <div class="loader-spinner"></div>
        <h2 id="loader-text" style="margin-top: 20px; font-family: serif;">Summoning DungeonMind...</h2>
        <p id="loader-sub" style="margin-top: 10px; font-size: 12px; color: #94a3b8;">Establishing Arcane Link...</p>
        <button id="force-offline-btn" onclick="window.dispatchEvent(new Event('force-offline'))">Force Offline Mode</button>
    </div>

    <div id="root"></div>

    <script>
        setTimeout(() => {
            const btn = document.getElementById('force-offline-btn');
            const loader = document.getElementById('app-loader');
            if(btn && loader && loader.style.display !== 'none') {
                btn.style.display = 'block';
                const sub = document.getElementById('loader-sub');
                if(sub) sub.innerText = "Network slow? Click below.";
            }
        }, 4000);
    </script>

    <script type="text/babel">
        const hideLoader = () => {
            const loader = document.getElementById('app-loader');
            if(loader && loader.style.display !== 'none') {
                loader.style.opacity = 0;
                setTimeout(() => loader.style.display = 'none', 500);
            }
        };

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const { useState, useEffect, useRef, Component } = React;

        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    hideLoader();
                    return (
                        <div className="h-screen flex flex-col items-center justify-center bg-red-950 text-white p-8 text-center">
                            <h1 className="text-2xl font-bold mb-2">Critical Failure</h1>
                            <p className="mb-4 bg-black/30 p-4 rounded font-mono text-xs text-left whitespace-pre-wrap">{this.state.error?.toString()}</p>
                            <button onClick={() => window.location.reload()} className="bg-white text-red-900 px-4 py-2 rounded font-bold">Reload App</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const useFirebase = () => {
            const [fb, setFb] = useState(null);
            const [user, setUser] = useState(null);
            const [isOffline, setIsOffline] = useState(false);
            const [isAuthReady, setIsAuthReady] = useState(false);

            useEffect(() => {
                let isMounted = true;
                const handleReady = () => {
                    if (!isMounted) return;
                    if (window.fbModules) {
                        const { auth, onAuthStateChanged } = window.fbModules;
                        onAuthStateChanged(auth, (u) => {
                            if (!isMounted) return;
                            setUser(u);
                            setIsAuthReady(true);
                        });
                        setFb({ ...window.fbModules, appId: 'dungeonmind' });
                    }
                };
                const handleOffline = () => {
                    if (!isMounted) return;
                    setIsOffline(true);
                    setIsAuthReady(true);
                };
                window.addEventListener('firebase-ready', handleReady);
                window.addEventListener('firebase-failed', handleOffline);
                window.addEventListener('force-offline', handleOffline);
                if (window.fbModules) handleReady();
                const timer = setTimeout(() => { if (!window.fbModules && !isAuthReady) handleOffline(); }, 5000);
                return () => {
                    isMounted = false;
                    window.removeEventListener('firebase-ready', handleReady);
                    window.removeEventListener('firebase-failed', handleOffline);
                    window.removeEventListener('force-offline', handleOffline);
                    clearTimeout(timer);
                };
            }, []);
            return { fb, user, isOffline, isAuthReady };
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.lucide && containerRef.current) {
                    window.lucide.createIcons({ 
                        root: containerRef.current, nameAttr: 'data-lucide', attrs: { class: `w-${size/4} h-${size/4} ${className}`, width: size, height: size } 
                    });
                }
            }, [name, size, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center"><i data-lucide={name}></i></span>;
        };

        const SafeRender = ({ children, className = "" }) => {
            let content = children;
            if (typeof children === 'object' && children !== null) {
                if(Array.isArray(children)) content = children.join(', ');
                else content = JSON.stringify(children).replace(/["{}]/g, '').replace(/,/g, ', ');
            }
            return <div className={className}>{content}</div>;
        };

        const OnboardingWizard = ({ onComplete, aiHelper }) => {
            const [step, setStep] = useState(1);
            const [data, setData] = useState({ sourceMode: 'new', campaignName: '', tone: 'Adventurous', conceptDesc: '', conflict: '', loreText: '' });
            const [isThinking, setIsThinking] = useState(false);
            const [verificationData, setVerificationData] = useState(null); 

            const steps = [{ id: 1, title: 'Source', icon: 'book' }, { id: 2, title: 'Tone', icon: 'music' }, { id: 3, title: 'Lore', icon: 'lightbulb' }, { id: 4, title: 'Conflict', icon: 'sword' }];

            const handleNext = () => { 
                if (step < 4) setStep(s => s + 1); 
                else onComplete(data); 
            };

            const verifyCampaign = async () => {
                if (!data.campaignName.trim() || isThinking) return;
                setIsThinking(true);
                const prompt = `Role: D&D 5e Expert. User Module: "${data.campaignName}". 
                Task: 
                1. Write a 1-paragraph summary of the setting/plot (max 150 words). 
                2. Identify the central conflict/BBEG (max 2 sentences). 
                3. Create a Yes/No trivia question to verify this is the correct campaign (e.g. "Is the setting Barovia?"). 
                Format JSON: { "lore": "...", "conflict": "...", "question": "...", "answer": "yes/no" }`;
                
                try {
                    const res = await aiHelper([{ role: "user", content: prompt }]);
                    const jsonMatch = res.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const vData = JSON.parse(jsonMatch[0]);
                        setVerificationData(vData);
                    } else {
                        alert("AI couldn't verify. Please enter details manually.");
                        setData({...data, sourceMode: 'new'}); 
                        setStep(s => s + 1);
                    }
                } catch(e) {
                    alert("Verification Error: " + e.message);
                }
                setIsThinking(false);
            };

            const confirmVerification = (isYes) => {
                if (isYes) {
                    setData(p => ({ ...p, loreText: verificationData.lore, conflict: verificationData.conflict }));
                    setVerificationData(null);
                    setStep(2); 
                } else {
                    alert("Let's try manual entry then.");
                    setVerificationData(null);
                    setData(p => ({ ...p, sourceMode: 'new', campaignName: '' })); 
                }
            };

            const handleBrainstorm = async () => {
                if (isThinking) return; setIsThinking(true);
                const prompt = `Role: DM Assistant. Context: A ${data.tone} campaign. Concept: ${data.conceptDesc}. Task: Suggest a central conflict. Max 2 sentences.`;
                try { const res = await aiHelper([{ role: "user", content: prompt }]); if (res) setData(p => ({ ...p, conflict: res })); } catch (e) { alert("AI Error: " + e.message); }
                setIsThinking(false);
            };

            return (
                <div className="fixed inset-0 z-[60] bg-slate-900 flex flex-col items-center justify-center p-4">
                    <div className="max-w-3xl w-full bg-slate-800/90 border border-amber-500/30 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="bg-slate-900 p-6 border-b border-slate-700 flex justify-between items-center"><div><h2 className="text-2xl fantasy-font text-amber-500">Genesis</h2><p className="text-slate-400 text-sm">Forging the world.</p></div><div className="flex gap-2">{steps.map(s => (<div key={s.id} className={`h-2 w-8 rounded-full ${step >= s.id ? 'bg-amber-500' : 'bg-slate-700'}`}></div>))}</div></div>
                        
                        <div className="flex-1 p-8 overflow-y-auto custom-scroll onboarding-step">
                            {/* Step 1: Source */}
                            {step === 1 && !verificationData && (
                                <div className="space-y-6">
                                    <div className="flex items-center gap-3 text-amber-400 mb-2"><Icon name="book" size={24}/><h3 className="text-xl font-bold">1. The Source</h3></div>
                                    <div className="grid md:grid-cols-2 gap-6">
                                        <div onClick={() => setData({...data, sourceMode: 'new'})} className={`p-6 rounded-lg border cursor-pointer ${data.sourceMode === 'new' ? 'bg-amber-900/40 border-amber-500' : 'bg-slate-700/50 border-slate-600 hover:bg-slate-700'}`}>
                                            <div className="font-bold text-lg mb-2 text-white">Homebrew World</div>
                                            <p className="text-sm text-slate-300">Forge a world from scratch or your own notes.</p>
                                        </div>
                                        <div onClick={() => setData({...data, sourceMode: 'official'})} className={`p-6 rounded-lg border cursor-pointer ${data.sourceMode === 'official' ? 'bg-amber-900/40 border-amber-500' : 'bg-slate-700/50 border-slate-600 hover:bg-slate-700'}`}>
                                            <div className="font-bold text-lg mb-2 text-white">Official Module</div>
                                            <p className="text-sm text-slate-300">Run a published campaign (e.g. Curse of Strahd).</p>
                                        </div>
                                    </div>
                                    {data.sourceMode === 'official' && (
                                        <div className="animate-in fade-in slide-in-from-top-4">
                                            <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Campaign Name</label>
                                            <div className="flex gap-2">
                                                <input value={data.campaignName} onChange={e => setData({...data, campaignName: e.target.value})} className="flex-1 bg-slate-900 border border-slate-600 p-3 rounded text-slate-200" placeholder="e.g. Lost Mine of Phandelver"/>
                                                <button onClick={verifyCampaign} disabled={isThinking || !data.campaignName} className="bg-indigo-600 hover:bg-indigo-500 text-white px-6 rounded font-bold flex items-center gap-2">
                                                    {isThinking ? <Icon name="loader-2" size={18} className="animate-spin"/> : <Icon name="search" size={18}/>} Verify
                                                </button>
                                            </div>
                                            <p className="text-xs text-slate-500 mt-2">The AI will check its archives to auto-fill lore.</p>
                                        </div>
                                    )}
                                </div>
                            )}

                            {step === 1 && verificationData && (
                                <div className="space-y-6 flex flex-col items-center text-center justify-center h-full">
                                    <Icon name="shield-check" size={48} className="text-green-500 mb-4"/>
                                    <h3 className="text-2xl font-bold text-white">Knowledge Check</h3>
                                    <p className="text-slate-300 max-w-md">I found data on this campaign. To make sure it's the right one:</p>
                                    <div className="bg-slate-900 p-6 rounded-xl border border-slate-700 max-w-lg w-full">
                                        <p className="text-lg font-bold text-amber-400 mb-6">"{verificationData.question}"</p>
                                        <div className="flex gap-4 justify-center">
                                            <button onClick={() => confirmVerification(true)} className="bg-green-600 hover:bg-green-500 text-white px-8 py-3 rounded-lg font-bold">Yes</button>
                                            <button onClick={() => confirmVerification(false)} className="bg-red-600 hover:bg-red-500 text-white px-8 py-3 rounded-lg font-bold">No</button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {step === 2 && (<div className="space-y-6"><div className="flex items-center gap-3 text-amber-400 mb-2"><Icon name="music" size={24}/><h3 className="text-xl font-bold">2. Define the Tone</h3></div><div className="grid grid-cols-2 md:grid-cols-4 gap-4">{['Heroic', 'Epic', 'Gritty', 'Comedic', 'Horror', 'Mystery'].map(t => (<button key={t} onClick={() => setData({...data, tone: t})} className={`p-4 rounded-lg border text-center transition-all ${data.tone === t ? 'bg-amber-600 border-amber-400 text-white' : 'bg-slate-700 border-slate-600 hover:border-amber-500/50'}`}>{t}</button>))}</div><input value={data.tone} onChange={e => setData({...data, tone: e.target.value})} className="w-full bg-slate-900 border border-slate-600 p-3 rounded text-slate-200" placeholder="Or type custom tone..."/></div>)}
                            
                            {step === 3 && (<div className="space-y-6"><div className="flex items-center gap-3 text-amber-400 mb-2"><Icon name="lightbulb" size={24}/><h3 className="text-xl font-bold">3. {data.sourceMode === 'official' ? "Review Lore" : "The Lore"}</h3></div>{data.sourceMode === 'new' ? (<div><p className="text-slate-300 mb-4">Core premise?</p><textarea value={data.conceptDesc} onChange={e => setData({...data, conceptDesc: e.target.value})} className="w-full h-48 bg-slate-900 border border-slate-600 p-3 rounded text-slate-200 resize-none" placeholder="Enter your campaign pitch..."/></div>) : (<div><p className="text-slate-300 mb-4">Auto-generated from module. Edit if needed:</p><textarea value={data.loreText} onChange={e => setData({...data, loreText: e.target.value})} className="w-full h-64 bg-slate-900 border border-slate-600 p-3 rounded text-slate-200 resize-none custom-scroll" placeholder="Campaign Lore..."/></div>)}</div>)}
                            
                            {step === 4 && (<div className="space-y-6"><div className="flex items-center gap-3 text-amber-400 mb-2"><Icon name="sword" size={24}/><h3 className="text-xl font-bold">4. Central Conflict</h3></div><div className="relative"><textarea value={data.conflict} onChange={e => setData({...data, conflict: e.target.value})} className="w-full h-40 bg-slate-900 border border-slate-600 p-3 rounded text-slate-200 resize-none" placeholder="An evil empire? A tournament?"/>{data.sourceMode === 'new' && (<button onClick={handleBrainstorm} disabled={isThinking} className="absolute right-2 bottom-2 bg-indigo-600/80 hover:bg-indigo-500 text-white px-3 py-1 rounded text-xs font-bold flex items-center gap-1">{isThinking ? <Icon name="loader-2" size={12} className="animate-spin"/> : <Icon name="wand-2" size={12}/>} AI Suggest</button>)}</div></div>)}
                        </div>
                        
                        <div className="bg-slate-900 p-6 border-t border-slate-700 flex justify-between">
                            {!verificationData && (
                                <>
                                    <button onClick={step === 1 ? () => onComplete(null) : () => setStep(s=>s-1)} className="text-slate-500 hover:text-white font-bold px-4 py-2">{step === 1 ? "Skip Wizard" : "Back"}</button>
                                    <button onClick={handleNext} disabled={step===1 && data.sourceMode==='official'} className={`bg-amber-600 hover:bg-amber-500 text-white font-bold px-6 py-2 rounded shadow-lg shadow-amber-900/20 ${step===1 && data.sourceMode==='official' ? 'opacity-50 cursor-not-allowed' : ''}`}>
                                        {step === 4 ? "Initialize Campaign" : "Next Step"}
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const JournalPageEditor = ({ page, onSave, onDelete, onBack }) => {
            const [localContent, setLocalContent] = useState(page.content || "");
            const [saveStatus, setSaveStatus] = useState("saved");
            const timerRef = useRef(null);

            useEffect(() => { if (saveStatus === "saved") setLocalContent(page.content || ""); }, [page.content]);

            const handleChange = (newVal) => {
                setLocalContent(newVal);
                setSaveStatus("saving");
                if (timerRef.current) clearTimeout(timerRef.current);
                timerRef.current = setTimeout(() => { onSave(page.id, { ...page, content: newVal }); setSaveStatus("saved"); }, 1000);
            };

            const toggleVisibility = () => {
                onSave(page.id, { ...page, isPublic: !page.isPublic });
            };

            return (
                <div className="flex flex-col h-full bg-slate-900/50">
                    <div className="p-3 md:p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/80">
                        <div className="flex items-center gap-2 overflow-hidden">
                            <button onClick={onBack} className="md:hidden text-slate-400 hover:text-white p-2 -ml-2">
                                <Icon name="arrow-left" size={24} />
                            </button>
                            <h3 className="font-bold text-base md:text-lg text-slate-200 truncate max-w-[140px] md:max-w-xs">{page.title}</h3>
                            <button onClick={toggleVisibility} className={`text-[10px] md:text-xs px-2 py-1 rounded flex items-center gap-1 transition-colors flex-shrink-0 ${page.isPublic ? 'bg-green-900/30 text-green-400 border border-green-800' : 'bg-red-900/30 text-red-400 border border-red-800'}`}>
                                <Icon name={page.isPublic ? "eye" : "eye-off"} size={12}/> <span className="hidden sm:inline">{page.isPublic ? "Public" : "Private"}</span>
                            </button>
                            <span className={`collab-status text-[10px] hidden sm:inline-block ${saveStatus === 'saved' ? 'status-saved' : 'status-saving'}`}>{saveStatus === 'saved' ? 'Saved' : 'Saving...'}</span>
                        </div>
                        <button onClick={() => onDelete(page.id)} className="text-slate-500 hover:text-red-500 flex-shrink-0 p-2"><Icon name="trash-2" size={20}/></button>
                    </div>
                    {/* Updated Textarea for full mobile height */}
                    <textarea 
                        value={localContent} 
                        onChange={e => handleChange(e.target.value)} 
                        className="flex-1 w-full bg-transparent p-4 md:p-6 resize-none focus:outline-none font-sans text-base md:text-lg text-slate-300 leading-relaxed custom-scroll pb-20 md:pb-4" 
                        placeholder="Write your entry here..."
                    />
                </div>
            );
        };

        const JournalView = ({ data, setData, role, updateJournalField, userId }) => {
            const pages = data.journal_pages || {};
            const [selectedPageId, setSelectedPageId] = useState(null);
            const [isCreating, setIsCreating] = useState(false);
            const [newPageTitle, setNewPageTitle] = useState("");
            const [newPagePublic, setNewPagePublic] = useState(true);

            const availablePages = Object.values(pages).filter(p => p.isPublic || p.ownerId === userId).sort((a,b) => b.created - a.created);

            useEffect(() => {
                // Only auto-select on Desktop
                if (window.innerWidth >= 768 && availablePages.length > 0 && !selectedPageId) setSelectedPageId(availablePages[0].id);
            }, [availablePages.length]);

            const handleCreate = () => {
                if (!newPageTitle.trim()) return;
                const newId = "page_" + Date.now();
                const newPage = {
                    id: newId, title: newPageTitle, content: "", ownerId: userId, isPublic: newPagePublic, created: Date.now()
                };
                updateJournalField(`journal_pages.${newId}`, newPage);
                setSelectedPageId(newId);
                setIsCreating(false);
                setNewPageTitle("");
            };

            const handleSavePage = (id, updatedPage) => { updateJournalField(`journal_pages.${id}`, updatedPage); };

            const handleDeletePage = (id) => {
                if(confirm("Delete this page permanently?")) {
                    if (selectedPageId === id) setSelectedPageId(null);
                    const newPages = { ...pages }; delete newPages[id]; updateJournalField('journal_pages', newPages);
                }
            };

            return (
                <div className="flex h-full w-full max-w-7xl mx-auto md:glass-panel md:rounded-xl overflow-hidden m-0 md:m-6 md:border border-slate-700">
                    {/* List View - Hidden on Mobile if page selected */}
                    <div className={`flex-col bg-slate-900 border-r border-slate-700 w-full md:w-64 ${selectedPageId ? 'hidden md:flex' : 'flex'} h-full`}>
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                            <h3 className="fantasy-font text-amber-500 text-lg">Journal</h3>
                            <button onClick={() => setIsCreating(true)} className="bg-amber-600 hover:bg-amber-500 text-white p-2 rounded"><Icon name="plus" size={20}/></button>
                        </div>
                        
                        {isCreating && (
                            <div className="p-3 bg-slate-800 border-b border-slate-700">
                                <input autoFocus value={newPageTitle} onChange={e=>setNewPageTitle(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-base text-white mb-2" placeholder="Page Title"/>
                                <div className="flex justify-between items-center mb-2">
                                    <label className="flex items-center gap-2 text-xs text-slate-300 cursor-pointer">
                                        <input type="checkbox" checked={newPagePublic} onChange={e=>setNewPagePublic(e.target.checked)} className="rounded bg-slate-700 border-slate-500 w-4 h-4"/>
                                        Public?
                                    </label>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={handleCreate} className="flex-1 bg-green-700 hover:bg-green-600 text-white text-xs py-2 rounded">Create</button>
                                    <button onClick={() => setIsCreating(false)} className="flex-1 bg-slate-700 hover:bg-slate-600 text-slate-300 text-xs py-2 rounded">Cancel</button>
                                </div>
                            </div>
                        )}

                        <div className="flex-1 overflow-y-auto custom-scroll pb-20 md:pb-0">
                            {availablePages.map(page => (
                                <div key={page.id} onClick={() => setSelectedPageId(page.id)} className={`p-4 border-b border-slate-800 cursor-pointer hover:bg-slate-800 transition-colors ${selectedPageId === page.id ? 'bg-slate-800 border-l-4 border-l-amber-500' : 'border-l-4 border-l-transparent'}`}>
                                    <div className="font-bold text-slate-200 text-base md:text-sm truncate">{page.title}</div>
                                    <div className="flex justify-between items-center mt-1">
                                        <span className="text-xs md:text-[10px] text-slate-500">{new Date(page.created).toLocaleDateString()}</span>
                                        <Icon name={page.isPublic ? "eye" : "lock"} size={12} className={page.isPublic ? "text-green-500" : "text-slate-500"}/>
                                    </div>
                                </div>
                            ))}
                            {availablePages.length === 0 && <div className="p-4 text-center text-slate-500 text-xs">No pages yet.</div>}
                        </div>
                    </div>

                    {/* Editor View - Full Screen on Mobile */}
                    <div className={`flex-1 h-full overflow-hidden bg-slate-900/30 ${selectedPageId ? 'flex' : 'hidden md:flex'} flex-col`}>
                        {selectedPageId && pages[selectedPageId] ? (
                            <JournalPageEditor page={pages[selectedPageId]} onSave={handleSavePage} onDelete={handleDeletePage} onBack={() => setSelectedPageId(null)} />
                        ) : (
                            <div className="h-full flex flex-col items-center justify-center text-slate-500">
                                <Icon name="book-open" size={48} className="mb-4 opacity-20"/>
                                <p>Select a page or create a new one.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const DiceTray = ({ diceLog, handleDiceRoll }) => (
            <div className="glass-panel p-4 rounded-lg mb-4">
                <h3 className="text-xs font-bold text-slate-500 uppercase mb-2">Dice Roller</h3>
                <div className="grid grid-cols-4 gap-2 mb-3">{[4, 6, 8, 10, 12, 20, 100].map(d => (<button key={d} onClick={() => handleDiceRoll(d)} className="bg-slate-700 hover:bg-amber-700 text-xs font-mono py-2 rounded border border-slate-600 transition-colors">d{d}</button>))}</div>
                <div className="h-24 overflow-y-auto custom-scroll bg-slate-900/50 rounded p-2 font-mono text-xs space-y-1">{diceLog.map(log => (<div key={log.id} className="flex justify-between border-b border-slate-800 pb-1"><span className="text-slate-400">{log.die}</span><span className={`font-bold ${log.result == 20 && log.die == 'd20' ? 'text-green-400' : log.result == 1 && log.die == 'd20' ? 'text-red-400' : 'text-amber-400'}`}>{log.result}</span></div>))}</div>
            </div>
        );
        
        const DesktopSidebar = ({ view, setView, code, showTools, setShowTools, onExit }) => (
            <aside className="hidden md:flex w-20 flex-col items-center bg-slate-900 border-r border-slate-800 py-4 z-20 h-full">
                <div className="mb-2 text-amber-500"><Icon name="dungeon" size={32} /></div>
                <div className="text-[10px] font-mono text-slate-500 mb-6 bg-slate-800 px-1 rounded">{code || "LOCAL"}</div>
                <nav className="flex-1 flex flex-col gap-4 w-full">
                    {['session', 'journal', 'world', 'party', 'npcs', 'settings'].map(v => (
                        <button key={v} onClick={() => setView(v)} className={`w-full py-3 flex justify-center transition-all border-l-4 ${view === v ? 'border-amber-500 bg-slate-800 text-amber-400' : 'border-transparent text-slate-500 hover:text-slate-200'}`}>
                            <Icon name={v === 'session' ? 'scroll-text' : v === 'journal' ? 'book-open-text' : v === 'world' ? 'map' : v === 'party' ? 'users' : v === 'npcs' ? 'skull' : 'settings-2'} size={24} />
                        </button>
                    ))}
                </nav>
                <button onClick={() => setShowTools(!showTools)} className={`mb-4 p-3 rounded-lg transition-colors ${showTools ? 'bg-amber-900/50 text-amber-400' : 'text-slate-500 hover:bg-slate-800'}`}><Icon name="hammer" size={20} /></button>
                <button onClick={onExit} className="mb-4 text-red-500 hover:bg-red-900/30 p-2 rounded"><Icon name="log-out" size={20}/></button>
            </aside>
        );

        const MobileNav = ({ view, setView, code, onExit }) => (
            <nav className="md:hidden fixed bottom-0 left-0 right-0 h-16 bg-slate-900 border-t border-slate-800 flex items-center justify-around z-50 pb-safe">
                 {['session', 'journal', 'world', 'party', 'npcs', 'settings'].map(v => (
                    <button key={v} onClick={() => setView(v)} className={`p-2 flex flex-col items-center justify-center ${view === v ? 'text-amber-500' : 'text-slate-500'}`}>
                        <Icon name={v === 'session' ? 'scroll-text' : v === 'journal' ? 'book-open-text' : v === 'world' ? 'map' : v === 'party' ? 'users' : v === 'npcs' ? 'skull' : 'settings-2'} size={20} />
                        <span className="text-[9px] uppercase mt-1">{v === 'npcs' ? 'NPCs' : v}</span>
                    </button>
                ))}
            </nav>
        );

        const WorldView = ({ data, setData, role, updateCloud, generateLoc }) => {
            const [genType, setGenType] = useState("Town");
            const [genNote, setGenNote] = useState("");
            const [isGenerating, setIsGenerating] = useState(false);
            const locations = data.locations || [];
            const genesis = data.campaign?.genesis || {};
            const updateGenesis = (field, val) => { const nd = { ...data, campaign: { ...data.campaign, genesis: { ...genesis, [field]: val } } }; setData(nd); updateCloud(nd); };
            const handleGen = async () => { if(isGenerating) return; setIsGenerating(true); const loc = await generateLoc(genType, genNote, genesis); if(loc) { const nd = { ...data, locations: [{id:Date.now(), ...loc}, ...locations] }; setData(nd); updateCloud(nd); } setIsGenerating(false); };
            const deleteLoc = (id) => { if(confirm("Delete Location?")) { const nd = { ...data, locations: locations.filter(l => l.id !== id) }; setData(nd); updateCloud(nd); } };
            return (
                <div className="max-w-7xl mx-auto p-4 md:p-6 h-full flex flex-col md:flex-row gap-6 overflow-hidden pb-20 md:pb-6">
                    <div className="w-full md:w-1/3 flex flex-col glass-panel rounded-xl overflow-hidden max-h-full">
                        <div className="p-4 border-b border-slate-700 bg-slate-800/50"><h3 className="fantasy-font text-xl text-amber-500 mb-2">Campaign Bible</h3><p className="text-xs text-slate-400">The core truths of your world.</p></div>
                        <div className="flex-1 overflow-y-auto custom-scroll p-4 space-y-4">
                            <div><label className="text-xs font-bold text-slate-500 uppercase">Tone</label><input disabled={role!=='dm'} value={genesis.tone || ""} onChange={e => updateGenesis('tone', e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded px-2 py-2 text-sm text-slate-200"/></div>
                            <div><label className="text-xs font-bold text-slate-500 uppercase">Conflict</label><textarea disabled={role!=='dm'} value={genesis.conflict || ""} onChange={e => updateGenesis('conflict', e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded px-2 py-2 text-sm text-slate-200 h-24 resize-none"/></div>
                            <div><label className="text-xs font-bold text-slate-500 uppercase">Lore / Concept</label><textarea disabled={role!=='dm'} value={genesis.loreText || genesis.conceptDesc || ""} onChange={e => updateGenesis(genesis.loreText ? 'loreText' : 'conceptDesc', e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded px-2 py-2 text-sm text-slate-200 h-64 resize-none custom-scroll"/></div>
                        </div>
                    </div>
                    <div className="flex-1 flex flex-col glass-panel rounded-xl overflow-hidden max-h-full">
                        <div className="p-4 border-b border-slate-700 bg-slate-800/50 flex justify-between items-center"><h3 className="fantasy-font text-xl text-amber-500">Atlas</h3></div>
                        {role === 'dm' && (<div className="p-4 bg-slate-900/30 border-b border-slate-700 flex flex-col md:flex-row gap-2"><div className="flex gap-2"><select value={genType} onChange={e => setGenType(e.target.value)} className="bg-slate-800 border border-slate-600 rounded px-3 py-2 text-sm text-white outline-none"><option value="Town">Town</option><option value="Dungeon">Dungeon</option><option value="Region">Region</option><option value="Shop">Shop</option></select><input value={genNote} onChange={e => setGenNote(e.target.value)} placeholder="Optional theme" className="flex-1 bg-slate-800 border border-slate-600 rounded px-3 py-2 text-sm text-white outline-none"/></div><button onClick={handleGen} disabled={isGenerating} className="bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded font-bold text-sm flex items-center justify-center gap-2">{isGenerating ? <Icon name="loader-2" size={16} className="animate-spin"/> : <Icon name="wand-2" size={16}/>} Generate</button></div>)}
                        <div className="flex-1 overflow-y-auto custom-scroll p-4 grid grid-cols-1 md:grid-cols-2 gap-4">{locations.map(loc => (<div key={loc.id} className="bg-slate-900/50 border border-slate-700 rounded p-4 relative hover:border-amber-500/30 transition-colors"><div className="flex justify-between items-start mb-2"><h4 className="font-bold text-amber-400">{loc.name}</h4><span className="text-[10px] uppercase bg-slate-800 px-2 py-1 rounded text-slate-400">{loc.type}</span></div><p className="text-sm text-slate-300 leading-relaxed whitespace-pre-wrap">{loc.desc}</p>{role === 'dm' && <button onClick={() => deleteLoc(loc.id)} className="absolute bottom-2 right-2 text-slate-600 hover:text-red-500 p-2"><Icon name="trash-2" size={16}/></button>}</div>))}{locations.length === 0 && <div className="col-span-full text-center text-slate-500 mt-10">No locations mapped yet.</div>}</div>
                    </div>
                </div>
            );
        };

        const NpcView = ({ data, setData, role, updateCloud, generateNpc, setChatInput, setView }) => {
            const [genName, setGenName] = useState("");
            const [genContext, setGenContext] = useState("");
            const [isGenerating, setIsGenerating] = useState(false);
            const [selectedNpc, setSelectedNpc] = useState(null);
            const [isEditing, setIsEditing] = useState(false);

            const npcs = data.npcs || [];
            const visibleNpcs = role === 'dm' ? npcs : npcs.filter(n => !n.isHidden);

            const handleGen = async () => {
                if(isGenerating) return; setIsGenerating(true);
                const npcData = await generateNpc(genName, genContext);
                if(npcData) { const newNpc = { id: Date.now(), isHidden: false, ...npcData }; const newNpcs = [...npcs, newNpc]; const nd = { ...data, npcs: newNpcs }; setData(nd); updateCloud(nd); setGenName(""); setGenContext(""); setSelectedNpc(newNpc); setIsEditing(false); }
                setIsGenerating(false);
            };

            const deleteNpc = (id, e) => {
                if(e) e.stopPropagation(); if(!confirm("Delete this NPC?")) return;
                const newNpcs = npcs.filter(n => n.id !== id); const nd = { ...data, npcs: newNpcs }; setData(nd); updateCloud(nd); if(selectedNpc?.id === id) setSelectedNpc(null);
            };
            
            const toggleHidden = (npc) => {
                const updated = { ...npc, isHidden: !npc.isHidden }; const newNpcs = npcs.map(n => n.id === npc.id ? updated : n); const nd = { ...data, npcs: newNpcs }; setData(nd); updateCloud(nd); if(selectedNpc?.id === npc.id) setSelectedNpc(updated);
            };

            const updateNpcField = (field, value) => {
                if(!selectedNpc) return;
                const updated = { ...selectedNpc, [field]: value };
                setSelectedNpc(updated);
                const newNpcs = npcs.map(n => n.id === updated.id ? updated : n);
                const nd = { ...data, npcs: newNpcs };
                setData(nd);
                updateCloud(nd);
            };

            return (
                <div className="max-w-7xl mx-auto p-4 md:p-6 h-full flex flex-col md:flex-row gap-6 pb-20 md:pb-6">
                    <div className={`${selectedNpc ? 'hidden md:flex' : 'flex'} w-full md:w-1/3 flex-col glass-panel rounded-xl overflow-hidden max-h-full`}>
                        <div className="p-4 border-b border-slate-700 bg-slate-800/50"><h3 className="fantasy-font text-xl text-amber-500 mb-2">NPC Registry</h3>{role === 'dm' && (<div className="space-y-2 p-3 bg-slate-900/50 rounded border border-slate-700"><div className="text-xs font-bold text-slate-400 uppercase">Generator</div><input value={genName} onChange={e=>setGenName(e.target.value)} placeholder="Name (e.g. 'Strahd')" className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-2 text-sm text-white"/><input value={genContext} onChange={e=>setGenContext(e.target.value)} placeholder="Role/Context (e.g. Shopkeeper)" className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-2 text-sm text-white"/><button onClick={handleGen} disabled={isGenerating} className="w-full bg-amber-700 hover:bg-amber-600 text-white text-xs font-bold py-3 rounded flex justify-center gap-2 items-center">{isGenerating ? <Icon name="loader-2" size={14} className="animate-spin"/> : <Icon name="wand-2" size={14}/>} Generate NPC</button></div>)}</div>
                        <div className="flex-1 overflow-y-auto custom-scroll p-2 space-y-2">{visibleNpcs.map(npc => (<div key={npc.id} onClick={() => { setSelectedNpc(npc); setIsEditing(false); }} className={`p-3 rounded cursor-pointer border transition-all relative group ${selectedNpc?.id === npc.id ? 'bg-amber-900/20 border-amber-500' : 'bg-slate-800 border-slate-700 hover:border-slate-500'} ${npc.isHidden ? 'opacity-50' : ''}`}><div className="font-bold text-slate-200 flex items-center gap-2">{npc.name}{role === 'dm' && npc.isHidden && <Icon name="eye-off" size={14} className="text-slate-500"/>}</div><div className="text-xs text-slate-500 truncate">{npc.race} {npc.class}</div>{role === 'dm' && (<button onClick={(e) => deleteNpc(npc.id, e)} className="absolute top-2 right-2 text-slate-600 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="trash-2" size={14}/></button>)}</div>))}{visibleNpcs.length === 0 && <div className="text-center text-slate-500 text-xs mt-4">No NPCs recorded.</div>}</div>
                    </div>
                    
                    <div className={`${selectedNpc ? 'flex' : 'hidden md:flex'} flex-1 glass-panel rounded-xl p-4 md:p-6 overflow-y-auto custom-scroll relative flex-col`}>
                        {selectedNpc && <button onClick={() => setSelectedNpc(null)} className="md:hidden absolute top-4 left-4 text-slate-400 bg-slate-800 rounded-full p-2 z-10"><Icon name="arrow-left" size={20}/></button>}
                        {selectedNpc ? (
                            <div className="space-y-4 pt-10 md:pt-0">
                                <div className="flex flex-col md:flex-row justify-between items-start border-b border-slate-700 pb-4 gap-4">
                                    <div className="flex-1 w-full">
                                        {isEditing ? (
                                            <div className="space-y-2">
                                                <input className="text-3xl font-bold bg-slate-900 border border-slate-600 rounded px-2 py-1 w-full text-white" value={selectedNpc.name} onChange={e => updateNpcField('name', e.target.value)} placeholder="Name"/>
                                                <div className="flex gap-2">
                                                    <input className="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-sm text-amber-500 w-1/2" value={selectedNpc.race} onChange={e => updateNpcField('race', e.target.value)} placeholder="Race"/>
                                                    <input className="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-sm text-amber-500 w-1/2" value={selectedNpc.class} onChange={e => updateNpcField('class', e.target.value)} placeholder="Class"/>
                                                </div>
                                            </div>
                                        ) : (
                                            <>
                                                <h2 className="text-3xl fantasy-font text-white">{selectedNpc.name}</h2>
                                                <div className="text-amber-500 font-mono text-sm">{selectedNpc.race} {selectedNpc.class}</div>
                                            </>
                                        )}
                                    </div>
                                    <div className="flex gap-2 w-full md:w-auto justify-end">
                                        {role === 'dm' && (
                                            <>
                                                <button onClick={() => toggleHidden(selectedNpc)} className={`p-3 rounded text-sm ${selectedNpc.isHidden ? 'bg-slate-700 text-slate-300' : 'bg-green-900/50 text-green-300'}`} title="Toggle Visibility"><Icon name={selectedNpc.isHidden ? "eye-off" : "eye"} size={16}/></button>
                                                <button onClick={() => setIsEditing(!isEditing)} className={`p-3 rounded text-sm ${isEditing ? 'bg-amber-600 text-white' : 'bg-slate-700 text-slate-300'}`} title="Edit NPC"><Icon name={isEditing ? "check" : "pencil"} size={16}/></button>
                                            </>
                                        )}
                                        <button onClick={() => { setChatInput(`(Playing as ${selectedNpc.name}) `); setView('session'); }} className="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded text-sm flex items-center gap-2"><Icon name="message-circle" size={16}/> Chat</button>
                                        {role === 'dm' && <button onClick={(e) => deleteNpc(selectedNpc.id, e)} className="bg-red-900/50 hover:bg-red-900 text-red-200 px-4 py-2 rounded text-sm"><Icon name="trash" size={16}/></button>}
                                    </div>
                                </div>
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div className="bg-slate-900/50 p-3 rounded border border-slate-700">
                                        <div className="text-xs font-bold text-slate-500 uppercase mb-1">Quirk</div>
                                        {isEditing ? <input className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm text-white" value={selectedNpc.quirk || ""} onChange={e => updateNpcField('quirk', e.target.value)}/> : <SafeRender className="text-slate-300 text-sm">{selectedNpc.quirk}</SafeRender>}
                                    </div>
                                    <div className="bg-slate-900/50 p-3 rounded border border-slate-700">
                                        <div className="text-xs font-bold text-slate-500 uppercase mb-1">Goal</div>
                                        {isEditing ? <input className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm text-white" value={selectedNpc.goal || ""} onChange={e => updateNpcField('goal', e.target.value)}/> : <SafeRender className="text-slate-300 text-sm">{selectedNpc.goal}</SafeRender>}
                                    </div>
                                </div>
                                <div className="bg-red-950/20 p-3 rounded border border-red-900/30">
                                    <div className="text-xs font-bold text-red-400 uppercase mb-1 flex items-center gap-2"><Icon name="eye-off" size={12}/> Secret</div>
                                    {isEditing ? <input className="w-full bg-slate-900 border border-red-900/50 rounded px-2 py-1 text-sm text-red-200" value={selectedNpc.secret || ""} onChange={e => updateNpcField('secret', e.target.value)}/> : <SafeRender className="text-slate-300 text-sm">{selectedNpc.secret}</SafeRender>}
                                </div>
                                <div className="bg-slate-900/30 p-4 rounded border border-slate-700">
                                    <div className="text-xs font-bold text-slate-500 uppercase mb-2 flex items-center gap-2"><Icon name="swords" size={14}/> Combat Stats & Abilities</div>
                                    <textarea className="w-full h-48 bg-slate-900/80 border border-slate-700 rounded p-3 text-sm text-green-300 font-mono leading-relaxed resize-none focus:outline-none focus:border-amber-500" value={typeof selectedNpc.stats === 'object' ? JSON.stringify(selectedNpc.stats, null, 2) : (selectedNpc.stats || "No stats generated.")} onChange={(e) => updateNpcField('stats', e.target.value)} />
                                </div>
                                <div>
                                    <div className="text-xs font-bold text-slate-500 uppercase mb-2">Personality Summary</div>
                                    <SafeRender className="text-slate-400 text-sm italic">{selectedNpc.personality}</SafeRender>
                                </div>
                            </div>
                        ) : (<div className="h-full flex flex-col items-center justify-center text-slate-500"><Icon name="skull" size={48} className="mb-4 opacity-20"/><p>Select or Generate an NPC to view details.</p></div>)}
                    </div>
                </div>
            );
        };

        const SettingsView = ({ data, setData, apiKey, setApiKey, role, updateCloud, handlePdfUpload, clearPdf, pdfProcessing, code, user, transferDM, banPlayer, kickPlayer, unbanPlayer, aiProvider, setAiProvider, fb, openAiModel, setOpenAiModel, puterModel, setPuterModel, onExit }) => {
            const copyCode = () => { navigator.clipboard.writeText(code); alert("Copied: " + code); };
            const activeUsers = data.activeUsers || {};
            const bannedUsers = data.bannedUsers || [];
            const userId = user ? user.uid : 'offline';
            const assignments = data.assignments || {};
            const genesis = data.campaign?.genesis || {};
            
            const updateGenesis = (field, val) => {
                const nd = { ...data, campaign: { ...data.campaign, genesis: { ...genesis, [field]: val } } };
                setData(nd);
                updateCloud(nd);
            };

            const signIn = async () => { try { await fb.signInWithPopup(fb.auth, new fb.GoogleAuthProvider()); } catch(e){alert(e.message);} };
            const signOut = async () => { if(fb) await fb.signOut(fb.auth); };
            const updateConfig = (key, val) => { const newData = { ...data, config: { ...data.config, [key]: val } }; setData(newData); updateCloud(newData); };
            const updateAssignment = (uid, charId) => { const newAssignments = { ...assignments, [uid]: charId }; const newData = { ...data, assignments: newAssignments }; setData(newData); updateCloud(newData); };
            const downloadBackup = () => { const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Campaign_${code}_Backup_${new Date().toISOString().split('T')[0]}.json`; link.click(); };
            const handleRestore = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const json = JSON.parse(event.target.result); if (!json.campaign || !json.players) { alert("Invalid backup file."); return; } if (confirm("Overwrite ALL data with backup?")) { setData(json); updateCloud(json); alert("Restored."); } } catch (err) { alert("Error: " + err.message); } }; reader.readAsText(file); e.target.value = null; };

            return (
                <div className="max-w-3xl mx-auto p-4 md:p-8 overflow-y-auto h-full custom-scroll w-full pb-20 md:pb-8">
                    <div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-2"><h2 className="text-3xl fantasy-font text-amber-500">Settings</h2></div>
                    <div className="glass-panel p-8 rounded-xl mb-8 flex flex-col items-center text-center border-2 border-indigo-500/30 bg-indigo-900/10 relative overflow-hidden w-full">
                        <h3 className="text-xs font-bold text-indigo-300 uppercase tracking-widest mb-2">Invite Code</h3>
                        <div className="text-4xl md:text-5xl font-mono font-bold text-white tracking-widest mb-4 drop-shadow-lg break-all">{code}</div>
                        <div className="flex flex-wrap justify-center gap-2 mb-4"><button onClick={copyCode} className="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded text-sm flex items-center gap-2 shadow-lg"><Icon name="copy" size={16}/> Copy</button>{fb && (user ? <button onClick={signOut} className="bg-slate-700 px-4 py-2 rounded text-sm">Sign Out</button> : <button onClick={signIn} className="bg-blue-600 px-4 py-2 rounded text-sm">Login</button>)}</div>
                        {/* Mobile Only Exit Button */}
                        <button onClick={onExit} className="md:hidden w-full bg-red-900/50 hover:bg-red-900 text-red-200 border border-red-800 py-3 rounded-lg font-bold flex items-center justify-center gap-2">
                            <Icon name="log-out" size={20} /> Return to Main Menu
                        </button>
                    </div>
                    {role === 'dm' && (
                        <div className="glass-panel p-6 rounded-xl border-l-4 border-blue-500 mb-6">
                            <h3 className="text-lg font-bold mb-4 text-slate-200">DM Tools</h3>
                            <div className="mb-4">
                                <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Story Source / Lore</label>
                                <textarea className="w-full bg-slate-900 border border-slate-700 p-3 rounded text-slate-200 outline-none h-40 resize-y custom-scroll" value={genesis.loreText || genesis.conceptDesc || ""} onChange={e => updateGenesis(genesis.loreText !== undefined ? 'loreText' : 'conceptDesc', e.target.value)} placeholder="Paste your world lore here for the AI to use..."/>
                            </div>
                            <div className="grid md:grid-cols-2 gap-6 mb-4">
                                <div><label className="block text-xs font-bold text-slate-400 uppercase mb-2">Edition</label><select value={data.config?.edition || '2014'} onChange={e => updateConfig('edition', e.target.value)} className="w-full bg-slate-900 border border-slate-700 p-3 rounded text-slate-200 outline-none"><option value="2014">5e (2014)</option><option value="2024">5e (2024 Revised)</option></select></div>
                                <div><label className="block text-xs font-bold text-slate-400 uppercase mb-2">AI Context</label><button onClick={() => updateConfig('strictMode', !data.config?.strictMode)} className={`w-full p-3 rounded text-sm font-bold border ${data.config?.strictMode ? 'bg-green-900/50 border-green-600 text-green-400' : 'bg-slate-900 border-slate-700 text-slate-400'}`}>{data.config?.strictMode ? "Strict" : "General"}</button></div>
                            </div>
                            <input value={data.campaign?.location || ""} onChange={e => { const newData = {...data, campaign: {...data.campaign, location: e.target.value}}; setData(newData); updateCloud(newData); }} className="w-full bg-slate-900 border border-slate-700 p-3 rounded text-slate-200 outline-none" placeholder="Current Location"/>
                            <div className="border-2 border-dashed border-slate-700 rounded p-4 text-center mt-4">
                                {pdfProcessing ? <div className="text-amber-500 animate-pulse">Processing...</div> : !data.campaign?.pdfName ? (<label className="cursor-pointer block w-full"><span className="text-slate-300 font-bold">Upload PDF</span><input type="file" className="hidden" accept=".pdf" onChange={handlePdfUpload}/></label>) : (<div className="flex justify-between items-center"><span className="text-green-400 truncate flex-1 mr-2">{data.campaign.pdfName}</span><button onClick={clearPdf}><Icon name="trash-2" size={16}/></button></div>)}
                            </div>
                        </div>
                    )}
                    <div className="glass-panel p-6 rounded-xl mb-6">
                        <h3 className="text-lg font-bold mb-4 text-slate-200 flex items-center gap-2"><Icon name="save" size={18}/> Backup & Restore</h3>
                        <div className="flex flex-col md:flex-row gap-4"><button onClick={downloadBackup} className="flex-1 bg-slate-700 hover:bg-slate-600 p-3 rounded text-slate-200 flex items-center justify-center gap-2"><Icon name="download" size={16}/> Download</button><label className="flex-1 bg-slate-700 hover:bg-slate-600 p-3 rounded text-slate-200 flex items-center justify-center gap-2 cursor-pointer"><Icon name="upload" size={16}/> Restore<input type="file" accept=".json" onChange={handleRestore} className="hidden" /></label></div>
                    </div>
                    {role === 'dm' && (
                        <div className="glass-panel p-6 rounded-xl mb-6 border-l-4 border-purple-500">
                            <h3 className="text-lg font-bold mb-4 text-slate-200 flex items-center gap-2"><Icon name="shield-alert" size={18}/> Moderation</h3>
                            <div className="space-y-3 mb-6">{Object.entries(activeUsers).map(([uid, email]) => (<div key={uid} className="flex flex-col md:flex-row justify-between items-start md:items-center bg-slate-900 p-3 rounded border border-slate-700 gap-3"><div className="text-sm w-full md:flex-1 flex flex-col"><div className="truncate font-bold text-slate-200">{email}{uid === userId && <span className="ml-2 text-xs text-green-500">(You)</span>}</div><div className="mt-2 flex items-center gap-2 w-full"><span className="text-[10px] text-slate-500 uppercase whitespace-nowrap">Assign:</span><select className="bg-slate-800 border border-slate-600 text-xs rounded px-2 py-1 text-white outline-none w-full md:w-auto flex-1" value={assignments[uid] || ""} onChange={(e) => updateAssignment(uid, e.target.value)}><option value="">Spectator</option>{data.players.map(p => <option key={p.id} value={p.id}>{p.name} ({p.race})</option>)}</select></div></div>{uid !== userId && (<div className="flex gap-2 w-full md:w-auto justify-end"><button onClick={() => transferDM(uid)} className="bg-purple-900 text-xs px-3 py-2 rounded flex-1 md:flex-none">DM</button><button onClick={() => kickPlayer(uid)} className="bg-amber-900 text-xs px-3 py-2 rounded flex-1 md:flex-none">Kick</button><button onClick={() => banPlayer(uid)} className="bg-red-900 text-xs px-3 py-2 rounded flex-1 md:flex-none">Ban</button></div>)}</div>))}</div>
                            {bannedUsers.length > 0 && <div className="space-y-2"><div className="text-xs text-red-400 uppercase font-bold">Banned</div>{bannedUsers.map(uid => <div key={uid} className="flex justify-between items-center bg-red-950/30 p-2 rounded border border-red-900/50"><span className="text-xs font-mono text-red-300 truncate flex-1">{uid.slice(0,8)}...</span><button onClick={() => unbanPlayer(uid)} className="text-xs text-slate-400 hover:text-white ml-2">Unban</button></div>)}</div>}
                        </div>
                    )}
                    <div className="glass-panel p-6 rounded-xl mb-6 border-l-4 border-amber-500">
                        <h3 className="text-lg font-bold mb-2 text-slate-200">AI Intelligence</h3>
                        <div className="mb-3">
                            <label className="block text-xs text-slate-400 mb-1">Provider</label>
                            <select value={aiProvider} onChange={e => setAiProvider(e.target.value)} className="w-full bg-slate-900 border border-slate-700 p-3 rounded text-slate-200 outline-none mb-3"><option value="puter">Puter.js (Free & Premium)</option><option value="gemini">Google Gemini (Direct)</option><option value="openai">OpenAI (Direct)</option></select>
                            {aiProvider === 'openai' && (<div><label className="block text-xs text-slate-400 mb-1">OpenAI Model</label><select value={openAiModel} onChange={e => setOpenAiModel(e.target.value)} className="w-full bg-slate-900 border border-slate-700 p-3 rounded text-slate-200 outline-none mb-2"><option value="gpt-4o">GPT-4o</option><option value="gpt-4o-mini">GPT-4o Mini</option><option value="gpt-4-turbo">GPT-4 Turbo</option></select><input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} className="w-full bg-slate-900 border border-slate-700 p-3 rounded text-slate-200 outline-none" placeholder="sk-..."/></div>)}
                            {aiProvider === 'puter' && (
                                <div>
                                    <label className="block text-xs text-slate-400 mb-1">Puter Model</label>
                                    <select value={puterModel} onChange={e => setPuterModel(e.target.value)} className="w-full bg-slate-900 border border-slate-700 p-3 rounded text-slate-200 outline-none mb-3">
                                        <option value="mistral-large-latest">Mistral Large (Recommended)</option>
                                        <option value="claude-3-5-sonnet">Claude 3.5 Sonnet</option>
                                        <option value="gpt-4o">GPT-4o</option>
                                        <option value="gpt-4o-mini">GPT-4o Mini</option>
                                        <option value="google-gemini-flash">Gemini 1.5 Flash</option>
                                        <option value="meta-llama-3-70b-instruct">Llama 3 (70B)</option>
                                        <option value="deepseek-chat">DeepSeek V3</option>
                                        <option value="deepseek-reasoner">DeepSeek R1 (Reasoning)</option>
                                    </select>
                                    <div className="bg-blue-900/30 border border-blue-600 rounded p-3"><div className="flex items-center gap-2 text-xs text-blue-300 mb-2"><Icon name="cloud" size={14}/><span>Powered by Puter.js (Serverless & Free)</span></div><button onClick={async () => { await puter.auth.signIn(); window.location.reload(); }} className="w-full bg-blue-700 hover:bg-blue-600 text-white text-xs py-3 rounded font-bold transition-colors">Connect & Reload</button></div>
                                </div>
                            )}
                            {aiProvider === 'gemini' && (<input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} className="w-full bg-slate-900 border border-slate-700 p-3 rounded text-slate-200 outline-none" placeholder="AIza..."/>)}
                        </div>
                    </div>
                </div>
            );
        };

        const PartyView = ({ data, setData, role, activeChar, updateCloud }) => {
            const [viewMode, setViewMode] = useState('stats');
            const updatePlayer = (idx, field, val) => { const newPlayers = data.players.map((p, i) => i === idx ? { ...p, [field]: val } : p); setData(prev => ({...prev, players: newPlayers})); updateCloud({...data, players: newPlayers}); };
            const addPlayer = () => { const newData = { ...data, players: [...data.players, { id: Date.now(), name: "New Hero", race: "Human", class: "Fighter", hp: 10, notes: "", backstory: "", appearance: "", motivation: "" }] }; setData(newData); updateCloud(newData); };
            return (
                <div className="max-w-4xl mx-auto p-4 md:p-8 overflow-y-auto h-full custom-scroll pb-20 md:pb-8">
                    <div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-2"><h2 className="text-3xl fantasy-font text-amber-500">Party</h2>{role === 'dm' && <button onClick={addPlayer} className="bg-amber-600 px-3 py-1 rounded text-sm font-bold">+ Add</button>}</div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {data.players?.map((p, idx) => {
                            const canEdit = role === 'dm' || activeChar === p.id;
                            return (
                                <div key={p.id} className={`glass-panel p-4 rounded-xl border-l-4 relative group ${activeChar == p.id ? 'border-green-500 bg-green-900/10' : 'border-amber-600'}`}>
                                    <div className="flex justify-between mb-2">
                                        <input disabled={!canEdit} className={`bg-transparent font-bold text-lg w-full outline-none ${!canEdit && 'text-slate-400'}`} value={p.name} onChange={e => updatePlayer(idx, 'name', e.target.value)} placeholder="Name"/>
                                        {role === 'dm' && <button onClick={() => { const nd = { ...data, players: data.players.filter(pl => pl.id !== p.id) }; setData(nd); updateCloud(nd); }} className="text-slate-600 hover:text-red-500 p-2"><Icon name="trash-2" size={16}/></button>}
                                        {activeChar == p.id && <span className="text-xs text-green-400 font-bold">YOU</span>}
                                    </div>
                                    <div className="flex gap-2 mb-2"><input disabled={!canEdit} className="w-1/2 bg-slate-800/50 rounded p-2 text-sm border border-transparent focus:border-amber-500 outline-none" value={p.race} placeholder="Race" onChange={e => updatePlayer(idx, 'race', e.target.value)}/><input disabled={!canEdit} className="w-1/2 bg-slate-800/50 rounded p-2 text-sm border border-transparent focus:border-amber-500 outline-none" value={p.class} placeholder="Class" onChange={e => updatePlayer(idx, 'class', e.target.value)}/></div>
                                    <div className="flex border-b border-slate-700 mb-2">
                                        <button onClick={() => setViewMode('stats')} className={`flex-1 text-xs py-2 ${viewMode === 'stats' ? 'text-amber-400 border-b-2 border-amber-400' : 'text-slate-500'}`}>Stats</button>
                                        <button onClick={() => setViewMode('appearance')} className={`flex-1 text-xs py-2 ${viewMode === 'appearance' ? 'text-amber-400 border-b-2 border-amber-400' : 'text-slate-500'}`}>Looks</button>
                                        <button onClick={() => setViewMode('bio')} className={`flex-1 text-xs py-2 ${viewMode === 'bio' ? 'text-amber-400 border-b-2 border-amber-400' : 'text-slate-500'}`}>Bio</button>
                                    </div>
                                    {viewMode === 'stats' && (
                                        <textarea disabled={!canEdit} className="w-full bg-slate-800/30 rounded p-2 text-sm h-32 resize-none custom-scroll border border-transparent focus:border-amber-500 outline-none" value={p.notes} placeholder="Inventory, Stats, Loot..." onChange={e => updatePlayer(idx, 'notes', e.target.value)}/>
                                    )}
                                    {viewMode === 'bio' && (
                                        <div className="space-y-2">
                                            <textarea disabled={!canEdit} className="w-full bg-slate-800/30 rounded p-2 text-sm h-24 resize-none custom-scroll border border-transparent focus:border-amber-500 outline-none" value={p.backstory} placeholder="Character backstory & personality..." onChange={e => updatePlayer(idx, 'backstory', e.target.value)}/>
                                            <input disabled={!canEdit} className="w-full bg-indigo-900/20 border border-indigo-900/50 rounded p-2 text-sm text-indigo-200 outline-none focus:border-indigo-500" value={p.motivation || ""} placeholder="Primary Motivation / Goal..." onChange={e => updatePlayer(idx, 'motivation', e.target.value)}/>
                                        </div>
                                    )}
                                    {viewMode === 'appearance' && (
                                        <textarea disabled={!canEdit} className="w-full bg-slate-800/30 rounded p-2 text-sm h-32 resize-none custom-scroll border border-transparent focus:border-amber-500 outline-none" value={p.appearance || ""} placeholder="Physical description for image generation (e.g. 'Tall, scar on left cheek, wearing plate armor')..." onChange={e => updatePlayer(idx, 'appearance', e.target.value)}/>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const SessionView = (props) => {
            const { 
                data, chatHistory, setChatHistory, inputText, setInputText, 
                isListening = false, toggleListening = () => {}, 
                generateResponse, isLoading, role, activeChar, 
                showTools, setShowTools, diceLog = [], handleDiceRoll = () => {}, syncState,
                isPlayerFacing, setIsPlayerFacing, updateCloud, generateSceneImage, aiProvider
            } = props;
            const chatEndRef = useRef(null);
            useEffect(() => chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }), [chatHistory, isLoading]);
            const charName = data.players?.find(p => p.id == activeChar)?.name || "Adventurer";

            const handleAction = (mode) => {
                if(mode === 'chaos') {
                    generateResponse(null, 'chaos');
                } else {
                    if (!inputText.trim()) return; 
                    generateResponse(null, mode);
                }
            };
            
            const handleImageGen = () => {
                if(isLoading) return;
                generateSceneImage();
            };

            const [showSavedSessions, setShowSavedSessions] = useState(false);

            return (
                <div className="flex h-full relative flex-col">
                    <div className="flex-1 flex flex-col h-full relative overflow-hidden">
                        <div className="h-12 border-b border-slate-800 flex items-center justify-between px-4 bg-slate-900/90 backdrop-blur shrink-0">
                            <div className="flex gap-2 items-center">
                                <div className={`live-status ${syncState === 'saved' ? 'status-online' : 'status-offline'}`}></div>
                                <span className="text-sm font-bold text-amber-500 truncate max-w-[120px]">{data.campaign?.location || "Unknown Location"}</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setShowSavedSessions(true)} className="p-2 hover:text-white text-slate-400"><Icon name="folder-open" size={18}/></button>
                                <button onClick={() => {
                                    const name = prompt("Name this session save:");
                                    if(name) {
                                        const newSession = { id: Date.now(), name: name, messages: chatHistory, date: Date.now() };
                                        const saved = [...(data.savedSessions || []), newSession];
                                        updateCloud({...data, savedSessions: saved});
                                    }
                                }} className="p-2 hover:text-white text-slate-400"><Icon name="save" size={18}/></button>
                                
                                {data.config?.strictMode && <span className="text-[10px] bg-blue-900/30 text-blue-400 px-1 rounded border border-blue-800 hidden sm:inline">STRICT</span>}
                                <div className={`text-xs px-2 py-1 rounded ${role === 'dm' ? 'bg-red-900/30 text-red-400' : 'bg-green-900/30 text-green-400'}`}>{role === 'dm' ? 'DM' : `PLAYER: ${charName}`}</div>
                            </div>
                        </div>

                        {showSavedSessions && (
                            <div className="absolute inset-0 z-50 bg-slate-900/95 backdrop-blur flex flex-col p-6">
                                <div className="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                                    <h3 className="text-xl fantasy-font text-amber-500">Saved Sessions</h3>
                                    <button onClick={() => setShowSavedSessions(false)}><Icon name="x" size={24}/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto custom-scroll space-y-2">
                                    {(data.savedSessions || []).map(s => (
                                        <div key={s.id} className="flex justify-between items-center bg-slate-800 p-3 rounded border border-slate-700 hover:border-amber-500/50 cursor-pointer" onClick={() => {
                                            if(confirm(`Load session "${s.name}"? Current chat will be replaced.`)) {
                                                setChatHistory(s.messages);
                                                setShowSavedSessions(false);
                                            }
                                        }}>
                                            <div><div className="font-bold text-slate-200">{s.name}</div><div className="text-[10px] text-slate-500">{new Date(s.date).toLocaleDateString()}  {s.messages.length} messages</div></div>
                                            <button onClick={(e) => { e.stopPropagation(); if(confirm("Delete save?")) { const saved = data.savedSessions.filter(x => x.id !== s.id); updateCloud({...data, savedSessions: saved}); } }} className="text-slate-500 hover:text-red-500 p-2"><Icon name="trash-2" size={16}/></button>
                                        </div>
                                    ))}
                                    {(!data.savedSessions || data.savedSessions.length === 0) && <div className="text-slate-500 text-center mt-10">No saved sessions yet.</div>}
                                </div>
                            </div>
                        )}

                        <div className="flex-1 overflow-y-auto custom-scroll p-4 space-y-6 chat-content">
                            {chatHistory.map((msg, i) => (
                                <div key={i} style={{textDecoration: 'none'}} className={`p-4 rounded-lg max-w-[95%] md:max-w-[85%] no-underline ${msg.role === 'user' ? 'bg-slate-800 ml-auto text-right' : msg.role === 'system' ? 'bg-slate-800/50 mx-auto text-center text-xs text-slate-500' : 'bg-indigo-900/20 border border-indigo-500/30 mr-auto'}`}>
                                    <div className="break-words" dangerouslySetInnerHTML={{__html: msg.content.replace(/~~([\s\S]*?)~~/g, '$1').replace(/<(s|strike|del)>([\s\S]*?)<\/\1>/gi, '$2').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br/>')}} />
                                    {msg.image && (
                                        <div className="mt-2 relative group">
                                            <img src={msg.image} className="chat-image" alt="Generated Scene"/>
                                            <div className="absolute bottom-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <a href={msg.image} download="scene.png" className="bg-black/70 text-white p-1 rounded"><Icon name="download" size={16}/></a>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                            {isLoading && <div className="text-center text-xs text-slate-500 animate-pulse">Thinking...</div>}
                            <div ref={chatEndRef}></div>
                        </div>
                        
                        <div className="p-2 md:p-4 bg-slate-900 border-t border-slate-800 flex flex-col gap-2 shrink-0 pb-20 md:pb-4">
                            <div className="flex gap-2 overflow-x-auto custom-scroll pb-1 w-full no-scrollbar">
                                {role === 'dm' ? (
                                    <>
                                        <button onClick={() => handleAction('narrate')} className="bg-blue-900/50 hover:bg-blue-800 text-blue-200 border border-blue-700/50 rounded-full px-4 py-2 text-xs flex items-center gap-1 transition-colors whitespace-nowrap flex-shrink-0"><Icon name="eye" size={14}/> Narrate</button>
                                        <button onClick={() => handleAction('mechanics')} className="bg-purple-900/50 hover:bg-purple-800 text-purple-200 border border-purple-700/50 rounded-full px-4 py-2 text-xs flex items-center gap-1 transition-colors whitespace-nowrap flex-shrink-0"><Icon name="settings" size={14}/> Mechanics</button>
                                        <button onClick={() => handleAction('npc')} className="bg-amber-900/50 hover:bg-amber-800 text-amber-200 border border-amber-700/50 rounded-full px-4 py-2 text-xs flex items-center gap-1 transition-colors whitespace-nowrap flex-shrink-0"><Icon name="users" size={14}/> NPC</button>
                                        <button onClick={() => handleAction('chaos')} className="bg-red-600/80 hover:bg-red-500 text-white border border-red-500 rounded-full px-4 py-2 text-xs flex items-center gap-1 transition-colors whitespace-nowrap flex-shrink-0 ml-auto font-bold animate-pulse"><Icon name="zap" size={14}/> CHAOS</button>
                                    </>
                                ) : (
                                    <>
                                        <button onClick={() => handleAction('action')} className="bg-red-900/50 hover:bg-red-800 text-red-200 border border-red-700/50 rounded-full px-4 py-2 text-xs flex items-center gap-1 transition-colors whitespace-nowrap flex-shrink-0"><Icon name="sword" size={14}/> Action</button>
                                        <button onClick={() => handleAction('speak')} className="bg-green-900/50 hover:bg-green-800 text-green-200 border border-green-700/50 rounded-full px-4 py-2 text-xs flex items-center gap-1 transition-colors whitespace-nowrap flex-shrink-0"><Icon name="message-circle" size={14}/> Speak</button>
                                        <button onClick={() => handleAction('recall')} className="bg-indigo-900/50 hover:bg-indigo-800 text-indigo-200 border border-indigo-700/50 rounded-full px-4 py-2 text-xs flex items-center gap-1 transition-colors whitespace-nowrap flex-shrink-0"><Icon name="brain" size={14}/> Recall</button>
                                    </>
                                )}
                            </div>

                            <div className="relative flex gap-2">
                                <div className="relative flex-1">
                                    <textarea value={inputText} onChange={e => setInputText(e.target.value)} onKeyDown={e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); generateResponse(); }}} placeholder={role==='dm' ? "DM Instruction..." : `What does ${charName} do?`} className="w-full bg-slate-800 text-white rounded-lg p-3 pr-20 resize-none h-14 focus:ring-1 focus:ring-amber-500 outline-none custom-scroll text-base"/>
                                    <div className="absolute right-2 top-2 flex gap-1">
                                        {aiProvider === 'puter' && (
                                            <button onClick={handleImageGen} title="Generate Scene Image" className="p-2 rounded-full text-slate-400 hover:text-amber-500 transition-colors relative"><Icon name="camera" size={20}/></button>
                                        )}
                                        <button onClick={toggleListening} className={`p-2 rounded-full ${isListening ? 'text-red-500 animate-pulse' : 'text-slate-400 hover:text-white'}`}><Icon name="mic" size={20}/></button>
                                    </div>
                                </div>
                                <button onClick={() => generateResponse()} className="bg-amber-600 hover:bg-amber-500 px-4 rounded-lg text-white h-14 flex items-center justify-center flex-shrink-0 w-14"><Icon name="send" size={24}/></button>
                            </div>
                        </div>
                    </div>
                    {showTools && (
                        <div className="absolute md:relative z-30 right-0 top-0 h-full w-64 md:w-72 bg-slate-900 border-l border-slate-800 flex flex-col p-4 gap-4 shadow-xl">
                            <div className="flex justify-between items-center mb-2"><span className="fantasy-font text-amber-500">Tools</span><button onClick={() => setShowTools(false)}><Icon name="x" size={24}/></button></div>
                            <DiceTray diceLog={diceLog} handleDiceRoll={handleDiceRoll} />
                        </div>
                    )}
                </div>
            );
        };

        const Lobby = ({ fb, user, onJoin, onOffline }) => {
            const [joinCode, setJoinCode] = useState("");
            const [isLoggingIn, setIsLoggingIn] = useState(false);
            const [recents, setRecents] = useState([]);

            useEffect(() => {
                try {
                    const saved = localStorage.getItem('dm_recents');
                    if (saved) setRecents(JSON.parse(saved));
                } catch(e) {}
            }, []);

            const handleLogin = async () => {
                if(!fb) return;
                setIsLoggingIn(true);
                try {
                    await fb.signInWithPopup(fb.auth, new fb.GoogleAuthProvider());
                    window.location.reload(); 
                } catch (e) { alert("Login Error: " + e.message); setIsLoggingIn(false); }
            };

            const addToRecents = (code, role) => {
                const newItem = { code, role, date: Date.now() };
                const newRecents = [newItem, ...recents.filter(r => r.code !== code)].slice(0, 5);
                setRecents(newRecents);
                localStorage.setItem('dm_recents', JSON.stringify(newRecents));
            };

            const createNew = () => {
                const newCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                addToRecents(newCode, 'dm');
                onJoin(newCode, 'dm', user ? user.uid : 'anon');
            };

            const joinExisting = () => {
                if(!joinCode) return;
                addToRecents(joinCode.toUpperCase(), 'player');
                onJoin(joinCode.toUpperCase(), 'player', user ? user.uid : 'anon');
            };

            const deleteCampaign = async (e, item) => {
                e.stopPropagation();
                if (item.role === 'dm') {
                    if (confirm(`PERMANENTLY DELETE Campaign ${item.code}?`)) {
                        try {
                            if (fb && fb.deleteDoc) await fb.deleteDoc(fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'campaigns', item.code));
                            const newRecents = recents.filter(r => r.code !== item.code);
                            setRecents(newRecents);
                            localStorage.setItem('dm_recents', JSON.stringify(newRecents));
                        } catch (err) { alert("Error deleting: " + err.message); }
                    }
                } else {
                    if (confirm("Remove from history?")) {
                        const newRecents = recents.filter(r => r.code !== item.code);
                        setRecents(newRecents);
                        localStorage.setItem('dm_recents', JSON.stringify(newRecents));
                    }
                }
            };

            return (
                <div className="h-dvh w-full flex items-center justify-center bg-[url('https://images.unsplash.com/photo-1519074069444-1ba4fff66d16?q=80&w=2544&auto=format&fit=crop')] bg-cover bg-center relative">
                    <div className="absolute inset-0 bg-slate-900/80 backdrop-blur-sm"></div>
                    <div className="relative z-10 w-full max-w-md p-8 glass-panel md:rounded-2xl shadow-2xl border-none md:border border-slate-700 max-h-[100dvh] overflow-y-auto custom-scroll h-full md:h-auto flex flex-col justify-center">
                        <div className="text-center mb-6">
                            <h1 className="text-4xl fantasy-font text-amber-500 mb-2 text-shadow">DungeonMind</h1>
                            <p className="text-slate-400 text-sm">AI-Enhanced TTRPG Assistant</p>
                        </div>
                        {!user && !fb && <div className="bg-red-900/30 border border-red-500 text-red-200 p-4 rounded mb-4 text-center text-sm">Firebase Disconnected. Only offline mode available.</div>}
                        {user ? (
                            <div className="bg-slate-800/50 p-4 rounded-lg mb-6 text-center border border-slate-700">
                                <div className="text-sm text-slate-400 mb-1">Logged in as</div>
                                <div className="font-bold text-green-400">{user.email}</div>
                                <button onClick={() => fb.signOut(fb.auth)} className="text-xs text-red-400 mt-2 hover:underline">Sign Out</button>
                            </div>
                        ) : (
                            fb && <button onClick={handleLogin} disabled={isLoggingIn} className="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-lg font-bold mb-6 flex justify-center items-center gap-2 transition-all shadow-lg">{isLoggingIn ? "Connecting..." : <><Icon name="log-in" size={20}/> Login with Google</>}</button>
                        )}
                        <div className="space-y-3">
                            <button onClick={createNew} className="w-full bg-amber-700 hover:bg-amber-600 text-white py-3 rounded-lg font-bold border border-amber-500/30 shadow-lg">Start New Campaign (DM)</button>
                            <div className="flex gap-2">
                                <input value={joinCode} onChange={e => setJoinCode(e.target.value.toUpperCase())} placeholder="ENTER CODE" className="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-4 text-center font-mono tracking-widest text-lg outline-none focus:border-amber-500 text-white placeholder:text-slate-600"/>
                                <button onClick={joinExisting} disabled={!joinCode} className={`px-6 rounded-lg font-bold ${joinCode ? 'bg-slate-600 hover:bg-slate-500 text-white' : 'bg-slate-800 text-slate-600 cursor-not-allowed'}`}>Join</button>
                            </div>
                            {recents.length > 0 && (
                                <div className="mt-6">
                                    <div className="text-xs uppercase font-bold text-slate-500 mb-2 ml-1">Recent Adventures</div>
                                    <div className="space-y-2">
                                        {recents.map((r, i) => (
                                            <div key={i} onClick={() => onJoin(r.code, r.role, user ? user.uid : 'anon')} className="group flex items-center justify-between bg-slate-800/50 hover:bg-slate-700 border border-slate-700 hover:border-amber-500/30 p-3 rounded-lg cursor-pointer transition-all">
                                                <div className="flex flex-col"><span className="font-mono font-bold text-amber-500 tracking-wider">{r.code}</span><span className="text-[10px] text-slate-400 uppercase">{r.role}</span></div>
                                                <div className="flex items-center gap-2"><span className="text-[10px] text-slate-500 mr-2">{new Date(r.date).toLocaleDateString()}</span><button onClick={(e) => deleteCampaign(e, r)} className={`p-2 rounded hover:bg-slate-900 ${r.role === 'dm' ? 'text-red-500 hover:text-red-400' : 'text-slate-500 hover:text-slate-300'}`}><Icon name={r.role === 'dm' ? "trash-2" : "x"} size={16}/></button></div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            <button onClick={onOffline} className="w-full text-slate-500 hover:text-slate-300 text-xs mt-4 py-2">Continue Offline (Local Only)</button>
                        </div>
                    </div>
                </div>
            );
        };

        const GameSession = (props) => {
            const { fb, code, role: initRole, userId, user, isOffline, onExit } = props;
            const DEFAULT = { hostId: userId, campaign:{ name:"New", location:"Start", tone:"Heroic", pdfName:null, pdfText:null, genesis:{}}, config:{edition:'2014', strictMode:false}, players:[], locations:[], journal_pages: {}, npcs: [], activeUsers:{}, bannedUsers:[], assignments:{}, onboardingComplete: false };
            const [data, setData] = useState(null);
            const [view, setView] = useState('session');
            const [role, setRole] = useState(initRole);
            const [activeChar, setActiveChar] = useState(null);
            const [chatHistory, setChatHistory] = useState([{role:'system', content:`Connected ${code}`}]);
            const [inputText, setInputText] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [apiKey, setApiKey] = useState('');
            const [aiProvider, setAiProvider] = useState(() => localStorage.getItem('dm_ai_provider') || 'puter');
            const [openAiModel, setOpenAiModel] = useState(() => localStorage.getItem('dm_openai_model') || 'gpt-4o'); 
            const [puterModel, setPuterModel] = useState(() => localStorage.getItem('dm_puter_model') || 'mistral-large-latest'); 
            const [pdfProcessing, setPdfProcessing] = useState(false);
            const [showTools, setShowTools] = useState(false);
            const [isListening, setIsListening] = useState(false);
            const [diceLog, setDiceLog] = useState([]);
            const [syncState, setSyncState] = useState('init');
            const [isPlayerFacing, setIsPlayerFacing] = useState(false);
            const [showTour, setShowTour] = useState(false);
            const saveTimer = useRef(null);
            const recognitionRef = useRef(null);

            const derivedActiveChar = data?.assignments?.[userId] || null;
            
            useEffect(() => { localStorage.setItem('dm_openai_model', openAiModel); }, [openAiModel]);
            useEffect(() => { localStorage.setItem('dm_puter_model', puterModel); }, [puterModel]);
            useEffect(() => { localStorage.setItem('dm_ai_provider', aiProvider); }, [aiProvider]);

            useEffect(() => { const k = localStorage.getItem(`dm_key_${aiProvider}`); setApiKey(k||''); }, [aiProvider]);
            const setKey = (v) => { setApiKey(v); localStorage.setItem(`dm_key_${aiProvider}`, v); };

            useEffect(() => {
                const tourSeen = localStorage.getItem('dm_tour_completed');
                if (!tourSeen && data) {
                    if (role === 'player' || data.onboardingComplete) {
                        setShowTour(true);
                    }
                }
            }, [data?.onboardingComplete, role]);

            useEffect(() => {
                if(isOffline) { const l=localStorage.getItem('dm_loc'); setData(l?JSON.parse(l):DEFAULT); hideLoader(); return; }
                const ref = fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'campaigns', code);
                const unsub = fb.onSnapshot(ref, snap => {
                    if(snap.exists()) {
                        const d = snap.data();
                        if (!d.journal_pages) {
                            d.journal_pages = {};
                            if (d.journal_public) d.journal_pages['legacy_public'] = { id: 'legacy_public', title: 'Public Log', content: d.journal_public, ownerId: 'system', isPublic: true, created: Date.now() };
                            if (d.partyStash) d.journal_pages['legacy_stash'] = { id: 'legacy_stash', title: 'Party Stash', content: d.partyStash, ownerId: 'system', isPublic: true, created: Date.now() + 1 };
                        }
                        if(d.bannedUsers?.includes(userId)) { alert("Banned"); onExit(); return; }
                        setData(d);
                        if(d.hostId === userId) setRole('dm'); else setRole('player');
                        hideLoader();
                    } else { 
                        if (initRole === 'dm') {
                             fb.setDoc(ref, DEFAULT).catch(e => { alert("Failed to create: " + e.message); onExit(); });
                        } else {
                             alert("Campaign not found."); onExit(); 
                        }
                    }
                });
                return () => unsub();
            }, [code]);
            
            useEffect(() => {
                if (!fb || isOffline || !data || !user) return;
                const register = async () => {
                    try {
                        const ref = fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'campaigns', code);
                        await fb.updateDoc(ref, { [`activeUsers.${user.uid}`]: user.email || "Anonymous" });
                    } catch(e) {}
                };
                register();
            }, [data?.campaign?.name]); 

            const updateCloud = (nd) => {
                setData(nd);
                if(isOffline) { localStorage.setItem('dm_loc', JSON.stringify(nd)); return; }
                if(saveTimer.current) clearTimeout(saveTimer.current);
                saveTimer.current = setTimeout(() => {
                    const ref = fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'campaigns', code);
                    if(role === 'player') fb.updateDoc(ref, { players: nd.players, journal_pages: nd.journal_pages });
                    else fb.setDoc(ref, nd, { merge: true, savedSessions: nd.savedSessions || [] }); 
                }, 1000);
            };

            const updateJournalField = (field, value) => {
                if (field.startsWith('journal_pages')) {
                    const parts = field.split('.');
                    if(parts.length === 2) {
                        const pageId = parts[1];
                        setData(prev => ({...prev, journal_pages: {...prev.journal_pages, [pageId]: value}}));
                    } else if (field === 'journal_pages') {
                        setData(prev => ({...prev, journal_pages: value}));
                    }
                } else {
                   setData(prev => ({...prev, [field]: value}));
                }

                if(isOffline) {
                    const nd = {...data};
                    if (field === 'journal_pages') nd.journal_pages = value;
                    else if (field.startsWith('journal_pages.')) {
                        const parts = field.split('.');
                        nd.journal_pages[parts[1]] = value;
                    } else nd[field] = value;
                    localStorage.setItem('dm_loc', JSON.stringify(nd));
                    return;
                }

                const ref = fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'campaigns', code);
                fb.updateDoc(ref, { [field]: value }).catch(err => console.error("Save failed", err));
            };

            const queryAiService = async (messages) => {
                const hasKey = aiProvider === 'puter' || apiKey;
                if (!hasKey) throw new Error("No API Key or Provider");
                let attempts = 0; const maxRetries = 2;
                while(attempts < maxRetries) {
                    try {
                        attempts++;
                        if(aiProvider === 'puter') {
                            if (!window.puter) throw new Error("Puter.js not loaded");
                            if (!window.puter.auth.isSignedIn()) await window.puter.auth.signIn();
                            const safeModel = puterModel || 'mistral-large-latest';
                            const response = await window.puter.ai.chat(messages, { model: safeModel });
                            if (!response || !response.message || !response.message.content) throw new Error("Invalid response structure from Puter AI");
                            return response.message.content;
                        } else if(aiProvider === 'gemini') {
                             const combinedPrompt = messages.map(m => `${m.role.toUpperCase()}: ${m.content}`).join('\n');
                             const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:combinedPrompt}]}]}) });
                             if(!r.ok) throw new Error(`Gemini Error ${r.status}`);
                             const j = await r.json();
                             return j.candidates?.[0]?.content?.parts?.[0]?.text;
                        } else {
                            const r = await fetch('https://api.openai.com/v1/chat/completions', { method:'POST', headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${apiKey}`}, body:JSON.stringify({model: openAiModel, messages: messages}) });
                            if(!r.ok) throw new Error(`OpenAI Error ${r.status}`);
                            const j = await r.json();
                            return j.choices?.[0]?.message?.content;
                        }
                    } catch(e) {
                        console.error(e);
                        const errMsg = e instanceof Error ? e.message : (typeof e === 'string' ? e : JSON.stringify(e));
                        if(attempts === maxRetries) throw new Error(errMsg || "Unknown Error");
                        await new Promise(res => setTimeout(res, 1000));
                    }
                }
            };
            
            const generateSceneImage = async () => {
                if(aiProvider !== 'puter') return;
                setIsLoading(true);
                try {
                    setChatHistory(p => [...p, {role: 'system', content: `Analyzing context for visualization...`}]);
                    const knownCharacters = data.players.map(p => {
                        const desc = p.appearance ? `Appearance: ${p.appearance}` : "No physical description provided.";
                        return `${p.name} (${p.race} ${p.class}). ${desc}.`;
                    }).join(" | ");
                    const journalContext = Object.values(data.journal_pages || {}).filter(p => p.isPublic).map(p => p.content).join(" ").slice(0, 500);
                    const chatContext = chatHistory.slice(-5).map(m => m.content).join(" ");
                    const metaPrompt = `Role: Art Director. Context: D&D. Characters: ${knownCharacters}. Log: ${journalContext}. Situation: ${chatContext}. Task: Write a vivid image prompt (max 50 words). Style: Digital Fantasy Art.`;
                    const imagePrompt = await queryAiService([{role: 'system', content: metaPrompt}, {role: 'user', content: 'Generate prompt.'}]);
                    setChatHistory(p => { const n = [...p]; n[n.length-1].content = `Painting scene...`; return n; });
                    const img = await window.puter.ai.txt2img(imagePrompt);
                    setChatHistory(p => [...p, {role: 'ai', content: `Visualized: ${imagePrompt.slice(0, 50)}...`, image: img.src}]);
                } catch(e) {
                    alert("Image Gen Failed: " + e.message);
                    setChatHistory(p => [...p, {role: 'system', content: `Image gen failed.`}]);
                } finally { setIsLoading(false); }
            };

            const genResponse = async (ov, mode = 'standard') => {
                const q = mode === 'chaos' ? "TRIGGER CHAOS" : (ov || inputText);
                if(!q.trim()) return;
                if(mode !== 'chaos') setChatHistory(p=>[...p, {role:'user', content:q}]); 
                if(mode !== 'chaos') setInputText('');
                setIsLoading(true);
                
                const char = data.players.find(p=>p.id==derivedActiveChar);
                const iden = role === 'dm' ? "DM" : (char ? `${char.name} (${char.race})` : "Player");
                const genesis = data.campaign?.genesis || {};
                
                let partyContext = "";
                if (role === 'dm') {
                    partyContext = data.players.map(p => `${p.name} (${p.race} ${p.class}). Motivation: ${p.motivation || "None"}. Bio: ${p.backstory ? p.backstory.slice(0,100)+'...' : 'None'}`).join(' | ');
                } else {
                    partyContext = `Me: ${char ? `${char.name} (${char.race}). Goal: ${char.motivation}` : "Spectator"}. Party: ${data.players.map(p => p.name).join(', ')}`;
                }

                const loreContext = genesis.loreText || genesis.conceptDesc || "Standard Fantasy";
                const accessiblePages = Object.values(data.journal_pages || {}).filter(p => p.isPublic || p.ownerId === userId);
                const journalContext = accessiblePages.map(p => `[Page: ${p.title}]: ${p.content}`).join('\n').slice(-4000);

                const systemPrompt = `
Role: Dungeon Master AI. 
User: ${iden}. 
World Context: Tone: ${genesis.tone || "Generic"}. Conflict: ${genesis.conflict || "None"}. Lore: ${loreContext}.
Location: ${data.campaign.location}.
Party: ${partyContext}.
Journals: ${journalContext}.
Rules: 5e (${data.config.edition}).
Instruction: ${mode === 'narrate' ? "Narrate vividly using boxed text. No secrets." : mode === 'mechanics' ? "Explain rules/DCs. Show math." : mode === 'npc' ? "Roleplay NPC." : mode === 'chaos' ? "Inject sudden random event. Bold text." : "Answer as DM."}
`;
                try {
                    const txt = await queryAiService([{ role: "system", content: systemPrompt }, ...chatHistory.slice(-10).map(m => ({role: m.role==='ai'?'assistant':m.role, content: m.content})), { role: "user", content: q }]);
                    if(txt) setChatHistory(p=>[...p, {role:'ai', content:txt}]);
                } catch(e) { setChatHistory(p=>[...p, {role:'system', content:`Failed: ${e.message}`}]); }
                setIsLoading(false);
            };

            const generateLoot = async (cr) => {
                try { return await queryAiService([{ role: "system", content: `Generate 5e loot for CR ${cr}. Comma separated list.` }, { role: "user", content: "Go."}]); } catch(e) { return null; }
            };

            const generateNpc = async (name, context) => {
                const genesis = data.campaign?.genesis || {};
                const prompt = `Create 5e NPC. Name: ${name}. Context: ${context}. Campaign Tone: ${genesis.tone}. Campaign Lore: ${genesis.loreText}. Include simplified 5e Statblock (AC, HP, Speed, Abilities) as a STRING, Weapons/Attacks as ARRAY of strings, and Spells as ARRAY of strings if applicable. Return JSON: {name, race, class, quirk, secret, goal, stats, personality, weapons, spells}`;
                try {
                    const txt = await queryAiService([{ role: "system", content: prompt }, { role: "user", content: "Gen"}]);
                    const start = txt.indexOf('{'); const end = txt.lastIndexOf('}'); if(start === -1 || end === -1) throw new Error("No JSON found");
                    const jsonStr = txt.substring(start, end + 1); const parsed = JSON.parse(jsonStr);
                    if (typeof parsed.stats === 'object') { parsed.stats = JSON.stringify(parsed.stats, null, 2).replace(/["{}]/g, ''); }
                    return parsed;
                } catch(e) { console.error("NPC Gen Error", e); return null; }
            };

            const generateLoc = async (type, note, genesis) => {
                const prompt = `Create a fantasy location. Type: ${type}. Theme: ${note}. Campaign Tone: ${genesis.tone}. Campaign Lore: ${genesis.loreText || genesis.conceptDesc}. Return JSON: {name, type, desc}`;
                try {
                    const txt = await queryAiService([{ role: "system", content: prompt }, { role: "user", content: "Gen"}]);
                    return JSON.parse(txt.replace(/```json/g, '').replace(/```/g, ''));
                } catch(e) { return null; }
            };

            const handlePdf = async (e) => {
                const f = e.target.files[0]; if(!f) return; setPdfProcessing(true);
                try {
                    const ab = await f.arrayBuffer(); const pdf = await pdfjsLib.getDocument({data:ab}).promise;
                    let t = ""; for(let i=1;i<=Math.min(pdf.numPages,50);i++) t+=(await (await pdf.getPage(i)).getTextContent()).items.map(s=>s.str).join(' ');
                    const nd = {...data, campaign:{...data.campaign, pdfName:f.name, pdfText:t}}; updateCloud(nd);
                } catch(e){alert("PDF Err");} finally { setPdfProcessing(false); }
            };
            
            const toggleListening = () => {
                if (!recognitionRef.current && ('webkitSpeechRecognition' in window)) {
                    const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new Speech(); recognitionRef.current.continuous = true; recognitionRef.current.lang = 'en-US';
                    recognitionRef.current.onresult = (e) => { let t = ''; for(let i=e.resultIndex;i<e.results.length;++i) if(e.results[i].isFinal) t+=e.results[i][0].transcript; if(t) setInputText(p=>p+' '+t); };
                    recognitionRef.current.start(); setIsListening(true);
                } else { if(isListening) { recognitionRef.current.stop(); setIsListening(false); } else { recognitionRef.current.start(); setIsListening(true); } }
            };
            
            const handleDiceRoll = (d) => {
                const r = Math.floor(Math.random()*d)+1;
                setDiceLog(p => [{id:Date.now(), die:`d${d}`, result:r}, ...p].slice(0,10));
                const hasKey = aiProvider === 'puter' || apiKey;
                if (!hasKey) { setChatHistory(p=>[...p, {role:'user', content:`Roll d${d}: ${r}`}]); } 
                else { genResponse(`Roll d${d}: ${r}`); }
            };

            const handleOnboardingComplete = (onboardingData) => {
                let newData = { ...data, onboardingComplete: true };
                if (onboardingData) {
                    newData.campaign = { ...newData.campaign, genesis: onboardingData };
                    newData.journal_pages = {};
                    newData.journal_pages['genesis'] = {
                        id: 'genesis',
                        title: 'Campaign Setup',
                        content: `Tone: ${onboardingData.tone}\nConflict: ${onboardingData.conflict}\nLore: ${onboardingData.loreText || onboardingData.conceptDesc}`,
                        ownerId: 'system',
                        isPublic: true,
                        created: Date.now()
                    };
                }
                updateCloud(newData);
            };

            if(!data) return <div className="h-screen flex items-center justify-center text-white">Syncing...</div>;

            return (
                <div className="flex h-dvh w-full bg-slate-900 text-slate-200 flex-col md:flex-row">
                    <DesktopSidebar view={view} setView={setView} code={code} showTools={showTools} setShowTools={setShowTools} onExit={onExit}/>
                    
                    <main className="flex-1 h-full overflow-hidden relative w-full">
                        {view === 'session' && <SessionView data={data} chatHistory={chatHistory} setChatHistory={setChatHistory} inputText={inputText} setInputText={setInputText} isListening={isListening} toggleListening={toggleListening} generateResponse={genResponse} isLoading={isLoading} role={role} activeChar={derivedActiveChar} showTools={showTools} setShowTools={setShowTools} diceLog={diceLog} handleDiceRoll={handleDiceRoll} syncState={syncState} isPlayerFacing={isPlayerFacing} setIsPlayerFacing={setIsPlayerFacing} updateCloud={updateCloud} generateSceneImage={generateSceneImage} aiProvider={aiProvider}/>}
                        {view === 'journal' && <JournalView data={data} setData={setData} role={role} updateJournalField={updateJournalField} userId={userId}/>}
                        {view === 'world' && <WorldView data={data} setData={setData} role={role} updateCloud={updateCloud} generateLoc={generateLoc}/>}
                        {view === 'party' && <PartyView data={data} setData={setData} role={role} activeChar={derivedActiveChar} updateCloud={updateCloud}/>}
                        {view === 'npcs' && <NpcView data={data} setData={setData} role={role} updateCloud={updateCloud} generateNpc={generateNpc} setChatInput={setInputText} setView={setView}/>}
                        {view === 'settings' && <SettingsView data={data} setData={setData} apiKey={apiKey} setApiKey={setKey} role={role} updateCloud={updateCloud} handlePdfUpload={handlePdf} clearPdf={()=>{const nd={...data, campaign:{...data.campaign, pdfName:null, pdfText:null}}; updateCloud(nd);}} pdfProcessing={pdfProcessing} code={code} user={user} transferDM={uid=>{if(confirm("Transfer?")){const ref=fb.doc(fb.db,'artifacts',fb.appId,'public','data','campaigns',code); fb.updateDoc(ref, {hostId:uid});}}} banPlayer={uid=>{if(confirm("Ban?")){const ref=fb.doc(fb.db,'artifacts',fb.appId,'public','data','campaigns',code); const na={...data.activeUsers}; delete na[uid]; fb.updateDoc(ref,{activeUsers:na, bannedUsers:fb.arrayUnion(uid)});}}} kickPlayer={uid=>{const ref=fb.doc(fb.db,'artifacts',fb.appId,'public','data','campaigns',code); const na={...data.activeUsers}; delete na[uid]; fb.updateDoc(ref, {activeUsers:na});}} unbanPlayer={uid=>{const ref=fb.doc(fb.db,'artifacts',fb.appId,'public','data','campaigns',code); fb.updateDoc(ref, {bannedUsers:fb.arrayRemove(uid)});}} aiProvider={aiProvider} setAiProvider={setAiProvider} fb={fb} openAiModel={openAiModel} setOpenAiModel={setOpenAiModel} puterModel={puterModel} setPuterModel={setPuterModel} isOffline={isOffline} onExit={onExit}/>}
                    </main>

                    <MobileNav view={view} setView={setView} code={code} onExit={onExit} />

                    {showTour && <TourGuide setView={setView} onClose={() => { setShowTour(false); localStorage.setItem('dm_tour_completed', 'true'); }} />}
                    {role === 'dm' && !data.onboardingComplete && <OnboardingWizard onComplete={handleOnboardingComplete} aiHelper={queryAiService} />}
                </div>
            );
        };

        const TourGuide = ({ onClose, setView }) => {
            const steps = [
                { title: "Welcome to DungeonMind", content: "Your AI-enhanced TTRPG assistant. This tool combines chat, journaling, and world-building.", view: 'session' },
                { title: "The Session Hub", content: "This is your main command center. Chat with the AI, roll dice, and see the story unfold.", view: 'session' },
                { title: "Infinite Journals", content: "Create unlimited journal pages. Toggle them Public (shared) or Private (your eyes + AI). On mobile, the editor takes the full screen.", view: 'journal' },
                { title: "The World Tab", content: "Your Campaign Bible and Atlas. Edit your world truths and generate locations here.", view: 'world' },
                { title: "NPC Registry", content: "The Skull icon. Create fully fleshed-out characters.", view: 'npcs' },
                { title: "DM Tools", content: "In Settings, DMs can now directly edit the core 'Lore Source' that powers the AI's world knowledge.", view: 'settings' }
            ];

            const [currentStep, setCurrentStep] = useState(0);

            useEffect(() => {
                if(steps[currentStep].view) setView(steps[currentStep].view);
            }, [currentStep]);

            const handleNext = () => {
                if (currentStep < steps.length - 1) setCurrentStep(c => c + 1);
                else onClose();
            };

            return (
                <div className="fixed inset-0 z-[100] pointer-events-none flex flex-col justify-end pb-20 px-4 md:pb-8">
                    <div className="pointer-events-auto bg-slate-900/95 backdrop-blur border-t-4 border-amber-500 rounded-xl p-6 max-w-2xl w-full shadow-2xl mx-auto relative animate-in slide-in-from-bottom-10 fade-in duration-500">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-500 hover:text-white bg-slate-800 rounded-full p-1 transition-colors"><Icon name="x" size={16}/></button>
                        <div className="flex gap-4 items-start">
                            <div className="bg-amber-900/20 p-3 rounded-full hidden sm:block"><Icon name="compass" size={32} className="text-amber-500"/></div>
                            <div className="flex-1">
                                <div className="flex justify-between items-center mb-1">
                                    <h3 className="text-lg md:text-xl fantasy-font text-amber-500 font-bold">{steps[currentStep].title}</h3>
                                    <span className="text-[10px] uppercase font-bold text-slate-500 bg-slate-800 px-2 py-1 rounded-full">{currentStep + 1} / {steps.length}</span>
                                </div>
                                <p className="text-slate-300 text-sm leading-relaxed mb-4">{steps[currentStep].content}</p>
                                <div className="flex justify-between items-center">
                                    <button onClick={onClose} className="text-xs text-slate-500 hover:text-slate-300 underline">Dismiss</button>
                                    <div className="flex gap-2">
                                        {currentStep > 0 && <button onClick={() => setCurrentStep(c => c - 1)} className="px-4 py-2 rounded bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold transition-colors">Back</button>}
                                        <button onClick={handleNext} className="px-6 py-2 rounded bg-amber-600 hover:bg-amber-500 text-white font-bold text-xs shadow-lg shadow-amber-900/20 transition-colors">
                                            {currentStep === steps.length - 1 ? "Finish Tour" : "Next Tip"}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const { fb, user, isAuthReady, isOffline } = useFirebase();
            const [view, setView] = useState('lobby');
            const [modeParams, setModeParams] = useState(null);

            const handleJoin = (code, role, uid) => {
                localStorage.setItem('dm_last_code', code);
                setModeParams({ fb, code, role, userId: uid, isOffline: false, user });
                setView('game');
            };

            const handleOffline = () => {
                setModeParams({ fb: null, code: 'LOCAL', role: 'dm', userId: 'local', user: {uid:'local',email:'Offline'}, isOffline: true });
                setView('game');
            };

            const handleExit = () => {
                localStorage.removeItem('dm_last_code'); 
                setModeParams(null);
                setView('lobby');
            };

            useEffect(() => {
                if (isAuthReady && !modeParams && !isOffline && fb && user) {
                    const lastCode = localStorage.getItem('dm_last_code');
                    if (lastCode) handleJoin(lastCode, 'player', user.uid);
                }
            }, [isAuthReady, user]);

            if (!isAuthReady) return null; 
            
            setTimeout(hideLoader, 100);

            if (view === 'lobby') return <Lobby fb={fb} user={user} onJoin={handleJoin} onOffline={handleOffline} />;

            return (
                <ErrorBoundary>
                    <GameSession {...modeParams} onExit={handleExit} />
                </ErrorBoundary>
            );
        };

        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        } catch (e) {
            console.error("React Mount Error:", e);
        }
    </script>
</body>
</html>


